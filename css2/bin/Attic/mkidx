#!/usr/local/bin/perl
# Index maker:
#
# Build an index table of all the anchors that have a name of the form:
# "<prefix>-<name>". In addition when a database is given with the '-db' option,
# information related to elements searched by names is added to the table.
# Table headers can be specified through the '-th' option.
#
# Arnaud Le Hors - lehors@w3.org
# $Id: mkidx,v 1.4 1997-08-01 13:29:16 ijacobs Exp $

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[1]) {
    print "Usage: $PROGNAME indexfile idxdb1 idxdb2 ...\n";
    exit 1;
} else {
    $indexf = $ARGV[0];
    shift;
}

sub readdbfile {
    $dbasef = $_[0];
    if (!open(DBASE, $dbasef)) {
	print STDERR "$PROGNAME Error: Cannot open dbfile: $dbasef\n";
	return;
    }
    while (<DBASE>)  {
	chop;
	($index, $url, $cmt) = split(/;/, $_, 3);
	#Sort on alphanumeric characters only.
	$index =~ s/^[^a-zA-Z0-9]*//;
	$key = "$index$cmt";
	if ($indexes{$key}) {
	    push(@{$indexes{$key}}, "$_");
	} else {
	    @{$indexes{$key}} = ("$_");
	}
    }
    close(DBASE);
}


### main
@indexes = ();
foreach $file (@ARGV) {
    readdbfile($file);
}

# print out index document
open(OUTPUT, "> $indexf");
$curindex = ();
$curletter = ();
$lastcmt = ();
foreach $key (sort(keys %indexes)) {
    foreach $item (@{$indexes{$key}}) {
	$cmt = ();
	($index, $url, $cmt) = split(/;/, $item, 3);

	if (($curindex) && ($curindex ne $index)) {
	    print OUTPUT "</dl>\n";
	}
	if ($curletter ne ($letter = lc(substr($key, 0, 1)))) {
	    $curletter = $letter;
	    print OUTPUT "<h2><a name=\"$letter\">" .
		uc($letter) . "</a></h2>\n";
	}
	if ($curindex ne $index) {
	    print OUTPUT "\n<dl><dt>$index";
	    $n = 1;
	    $curindex = $index;
	}
	if ($cmt ne "") {
	    # If there is an index subkey
	    if ($lastcmt ne $cmt) {
		# If the subkey is not the same
		# as the previous one, start
		# a new subkey list.
		print OUTPUT "\n<dd> $cmt";
		$pre = "\n, <a href=\"$url\">";
		$content = "1";
		$post = "</a>";
		$n = 2;
		$lastcmt = $cmt;
	    } else {
		# Add number to current subkey list.
		$pre = "\n, <a href=\"$url\">";
		$content = $n;
		$post = "</a>";
		$n++;
	    }
	} else {
	    # Add number to current index line.
	    $pre = "\n, <a href=\"$url\">";
	    $content = $n;
	    $post = "</a>";
	    $n++;
	}
	$_ = $url;
	if (/\#didx-/) {
	    $content = "<em>$content</em>";
	}
	print OUTPUT "$pre$content$post";
    }
}
print OUTPUT "</dl>\n";
close(OUTPUT);
