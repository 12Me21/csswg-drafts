#!/usr/local/bin/perl
# Extract all the anchors that have a name of the form: "<prefix>-<name>"
# and build a database for it.
#
# Arnaud Le Hors - lehors@w3.org
# $Id: mkanchdb,v 1.1 1997-07-29 17:14:53 ijacobs Exp $

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[0] || !$ARGV[1]) {
    print "Usage: $PROGNAME prefix dbase src1 src2 ...\n";
    exit 1;
} else {
    $prefix = $ARGV[0];
    shift;
    $dbasef = $ARGV[0];
    shift;
}

# copy file in memory
sub readfile {
    $buf = "";
    if (!open(INPUT, $_[0])) {
	print STDERR "$PROGNAME Error: Cannot open file: $_[0]\n";
	return;
    }
    while (<INPUT>) {
	$buf .= $_;
    }
    close(INPUT);
}

# store anchor
sub addanchor {
    if ($anchors{$_[0]}) {
	print STDERR "$PROGNAME Warning: duplicated index: \"$_[0]\" found both @\n";
	print STDERR "\t    $anchors{$_[0]}\n";
	print STDERR "\tand $_[1]\n";
    } else {
	$anchors{$_[0]} = $_[1];
    }
}

# look for index anchors
$banchorp = "<a[ \t\n]+name=";
$eanchorp = ".*?>";
# non quoted name
$namep = "$prefix-([^\"][^ \t\n>]+)";
# quoted name
$qnamep = "\"$prefix-([^\"]+)\"";
sub seekanchors {
    $_ = $buf;
    while (/$banchorp$namep$eanchorp/sio) {
	addanchor($1, "$file#$prefix-$1");
	$_ = $';
    }
    $_ = $buf;
    while (/$banchorp$qnamep$eanchorp/sio) {
	addanchor($1, "$file#$prefix-$1");
	$_ = $';
    }
}


### main

# search for all the anchors
@anchors = ();
foreach $file (@ARGV) {
    readfile($file);
    seekanchors();
}

# print out database
if (!open(DBASE, "> $dbasef")) {
    print STDERR "$PROGNAME Error: Cannot open dbfile: $dbasef\n";
} else {
    foreach $key (sort(keys %anchors)) {
	print DBASE "$key;$anchors{$key}\n";
    }
    close(DBASE);
}
