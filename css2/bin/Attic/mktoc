#!/usr/local/bin/perl
# Generate a table of contents plus a database of headings
# When an HTML comment is found right before the end tag of a header its
# content is added as a description note to the TOC like this:
#   1. Some header - and its related comment
#
# Arnaud Le Hors - lehors@w3.org
# $Id: mktoc,v 1.18 1997-12-16 20:42:10 ijacobs Exp $

$startlvl = 1;
$maxlvl = 0;
$maxollvl = 0;

while ($_ = $ARGV[0], /^-/) {
    if (/^-l/) {
	shift;
	$startlvl = $ARGV[0];
    } elsif (/^-ml/) {
	shift;
	$maxlvl = $ARGV[0];
    } elsif (/^-mol/) {
	shift;
	$maxollvl = $ARGV[0];
    } else {
	last;
    }
    shift;
}

$PROGNAME = substr($0, rindex($0, "/") + 1);

if ($#ARGV < 2) {
    die "Usage: $PROGNAME [-l startlvl] [-ml level] [-mol level] toc tocdb src1 src2 ...
\t-l   to give the level from which headings should be put into the toc
\t-ml  set the maximum level to be put into the toc
\t-mol set the level from which to use an unordered list
The default is to use an ordered list but this can be changed anytime, by
inserting the flags -ul and -ol, possibly followed by -none for non bulleted
unordered lists and -roman for roman ordered lists\n";
}
$tocf = $ARGV[0];
shift;
$tocdb = $ARGV[0];
shift;

# copy file in memory
sub readfile {
    open(INPUT, $_[0]) || die "$PROGNAME Error: Cannot open file: $_[0]\n";
    undef $/;			# read file as a single block
    $buf = <INPUT>;
    $/ = "\n";			# reset input record separator
    close(INPUT);
}

sub hnuminit {
    @n = ();
    @ol = ();
    $ol[0] = "";
}

sub hnum {
    $h = $_[0];
    if ($h == 0 && $#n < 0) {
	return;
    }

    $hn = $h - $startlvl;
    for ($i = $#n; $i > $hn; $i--) {
	if ($ol[$i] ne "") {
	    $ol[$i] = "";
	}
	$n[$i] = 0;
    }
    if ((($maxlvl == 0) || ($h <= $maxlvl)) && $hn >= 0 && $ol[$hn] eq "") {
	if ($maxollvl == 0 || $h <= $maxollvl) {
	    if ($h == $startlvl) {
		$ol[$hn] = "$list";
	    } else {
		$ol[$hn] = "ol";
	    }
	} else {
	    $ol[$hn] = "ul";
	}
    }
    $n[$hn]++;
    if (($_ = $listtype, /A/) && $h == 1) {
	$num = chr(65 + $n[0] - 1);
    } elsif (($_ = $listtype, /toc/) && $h == 1) {
	$num = "$n[0]";
    } else {
	$num = "$n[0]";
	# Use alphabet entries at first level only (i.e., A.1, not A.A)
	$listtype = "";
    }
    for ($i = 1; $i <= $hn; $i++) {
	$num .= ".$n[$i]";
    }
    return $num;
}

sub cleanup {
    $text = $_[0];
    $text =~ s/[ \t]*$//sgi;
    return $text;
}


### main

# search for all the headings
$headingp = "<h([1-6]).*?>(.*?)(?:<!--(.*?)-->)?</h[1-6]>";

open(DBASE, "> $tocdb");
open(OUTPUT, "> $tocf");
hnuminit();
$list = "ol";
$listtype = "";
$prevh = 0;
print OUTPUT "<DIV CLASS=\"toc\">\n";
LOOP: foreach $file (@ARGV) {
    if ($file eq "-ul") {	# start a new unordered list
	while ($prevh > 0) {
	    print OUTPUT "</$list>\n";
	    $prevh -= 1;
	}
	$list = "ul";
	$listtype = "";
	hnum(0);
	hnuminit();
	next LOOP;
    } elsif ($file eq "-ol") { # start a new ordered list
	while ($prevh > 0) {
	    print OUTPUT "</$list>\n";
	    $prevh -= 1;
	}
	$list = "ol";
	$listtype = "";
	hnum(0);
	hnuminit();
	next LOOP;
    } elsif ($file eq "-roman") { # make ordered list roman
	$listtype = " type=\"A\"";
	next LOOP;
    } elsif ($file eq "-none") { # make unordered list with no bullets
	$listtype = " class=\"toc\""; # we must rely on CSS for this one
	next LOOP;
    }
    readfile($file);
    # change extension
    $hfil = $file;
    $hfil =~ s/\.src$/\.html/;
    # seek headings
    $_ = $buf;
    while (/$headingp/sio) {
	$h = int($1);
	$t = "$2";
	$txt = cleanup($t);
	$cmt = $3;
	if ($h >= $startlvl && (($maxlvl == 0) || ($h <= $maxlvl))) {
	    # compute section number
	    $num = hnum($h);
	    # Reuse first anchor in header.
	    $hasanchor = ();
	    if ($t =~ /<a[^>]+>/si) {
		$hasanchor = t;
		# let's reuse it
		$anch = $&;
		if ($anch =~ /name\s*=\s*(?:([^\s>\"]+)|\"([^\">]+)\")/sig) {
		    #Only one of two will match.
		    $anchor = "$1$2";
		    $txt =~ s/name\s*=\s*$anchor/href=\"$hfil#$anchor\"/isg;
		    $txt =~ s/name\s*=\s*\"$anchor\"/href=\"$hfil#$anchor\"/isg;
		}
	    } else {
		$anchor = "h-$num";
		if ($h == 1) {	# if H1 go to the top of the page and set rel
		    $url = "$hfil";
		    $rel= " rel=\"chapter\"";
		} else {
		    $url = "$hfil#$anchor";
		    $rel = "";
		}
	    }
	    if ($list eq "ol" && $listtype eq " class=\"toc\"") {
		$tnum = "$num&nbsp; ";
	    } else {
		$tnum ="";
	    }
	    while ($h > $prevh) {
		print OUTPUT "<$list$listtype>\n";
		$prevh += 1;
	    }
	    while ($h < $prevh) {
		print OUTPUT "</$list>\n";
		$prevh -= 1;
	    }
	    if ($hasanchor) {
		print OUTPUT "<li class=tocline$h>$tnum$txt\n";
	    } else {
		print OUTPUT "<li class=tocline$h>$tnum<a href=\"$url\"$rel>$txt</a>\n";
	    }
	    if ($cmt) {
		print OUTPUT " <em>-$cmt</em>";
	    }

	    # dbase format: file;headingtext;h;hnum
	    print DBASE "$file;$t;$h;$num;$anchor\n";
	}
	$_ = $';
    }
}
while ($prevh > 0) {
    print OUTPUT "</$list>\n";
    $prevh -= 1;
}
print OUTPUT "</DIV>\n";
hnum(0);			# close all open lists
close(OUTPUT);
close(DBASE);
