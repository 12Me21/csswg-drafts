#!/usr/local/bin/perl
# Add heading anchors
# Arnaud Le Hors - lehors@w3.org
# $Id: addhanch,v 1.2 1997-08-01 14:19:47 lehors Exp $

if (($_ = $ARGV[0], /^-n$/)) {
    $addnums = true;
    shift;
} else {
    $addnums = ();
}

if (($_ = $ARGV[0], /^-ml$/) && $ARGV[1]) {
    shift;
    $maxlvl = int($ARGV[0]);
    shift;
} else {
    $maxlvl = 0;
}

if (($_ = $ARGV[0], /^-top$/)) {
    $top = true;
    shift;
} else {
    $top = ();
}

if (($_ = $ARGV[0], /^-r/) && $ARGV[1]) {
    shift;
    $realpath = $ARGV[0];
    shift;
} else {
    $realpath = ();
}

$PROGNAME = substr($0, rindex($0, "/") + 1);

if ($#ARGV < 2) {
    print STDERR "Usage: $PROGNAME [-n] [-ml level] [-top] [-r realpath] src trgt headingdb
\t-n   to have numbers added on the headings
\t-ml  to give the maximum heading level on which to add numbers
\t-top to avoid numbers on subheadings (H2-6) in \"*top.src\" files
\t-r   to give the real path to the source file\n";
    exit 1;
} else {
    $input = $ARGV[0];
    if (! $realpath) {
	$realpath = $input;
    }
    $_ = $realpath;
    if ($top && !/.*top\.src/) { # "*top.src" files moved one level up
	$top = ();
    }
    shift;
    $output = $ARGV[0];
    shift;
    $hdbasef = $ARGV[0];
    shift;
}

# copy file in memory
sub readfile {
    $buf = "";
    if (!open(INPUT, $_[0])) {
	print STDERR "$PROGNAME Error: Cannot open file: $_[0]\n";
	exit 1;
    }
    while (<INPUT>) {
	$buf .= $_;
    }
    close(INPUT);
}

# args: stag hnum heading etag
sub addanchor {
    $key = "$realpath$n";
    $n++;
    $data = $hdbase{$key};
    if ($data) {
	($h, $hnum, $heading) = split(";", $data, 3);
	if ($h == $_[1]) {
	    if ($addnums && (!$top || $h == 1) &&
		(($maxlvl == 0) || ($h < $maxlvl))) {
		$num = "$hnum ";
		return "$_[0]<a name=\"h-$hnum\">$hnum</a> $_[2]$_[3]";
	    } else {
		# HACK!!!
		# add a non breakable space in the anchor to workaround
		# broken browsers which don't support correctly empty anchors
		return "$_[0]$_[2]<a name=\"h-$hnum\">&nbsp;</a>$_[3]";
	    }
	}
    }
    print STDERR "Heading database out of date, could not find entry!
                  : $key\n";
    return "$_[0]$_[2]$_[3]";
}


### main

# read heading database
readfile($hdbasef);
$_ = $buf;
$prevf = "";
while (/(.*?);(.*?);([0-9]*);([1-9].*?)\n/sio) {
    $file = $1;
    $heading = $2;
    $h = int($3);
    $hnum = $4;
    if ($file ne $prevf) {
	$n = 0;
	$prevf = $file;
    } else {
	$n++;
    }
    $key = "$file$n";
    $hdbase{$key} = "$h;$hnum;$heading";
    $_ = $';
}

readfile($input);

# insert heading anchors
$headingp = "(<h([1-6]).*?>)(.*?)(</h[1-6]>)";
$n = 0;
$buf =~ s/$headingp/addanchor($1, $2, $3, $4)/sgieo;

# print out result
open(OUTPUT, "> $output");
print OUTPUT $buf;
close(OUTPUT);
