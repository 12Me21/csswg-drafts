#!/usr/local/bin/perl
# Add heading anchors
# Arnaud Le Hors - lehors@w3.org
# $Id: addhanch,v 1.5 1997-12-09 00:08:34 ijacobs Exp $

if (($_ = $ARGV[0], /^-n$/)) {
    $addnums = true;
    shift;
} else {
    $addnums = ();
}

if (($_ = $ARGV[0], /^-l/) && $ARGV[0]) {
    shift;
    $startlvl = $ARGV[0];
    shift;
} else {
    $startlvl = 1;
}

if (($_ = $ARGV[0], /^-ml$/) && $ARGV[1]) {
    shift;
    $maxlvl = int($ARGV[0]);
    shift;
} else {
    $maxlvl = 0;
}

if (($_ = $ARGV[0], /^-h1p$/) && $ARGV[1]) {
    shift;
    $h1prefix = $ARGV[0];
    shift;
} else {
    $h1prefix = "";
}

if (($_ = $ARGV[0], /^-r/) && $ARGV[1]) {
    shift;
    $realpath = $ARGV[0];
    shift;
} else {
    $realpath = ();
}

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[0]) {
    die "Usage: $PROGNAME [-n] [-l startlvl] [-ml level] [-h1p prefix] [-r realpath] headingdb src trgt 
\t-n   to have numbers added on the headings
\t-l   to give the level from which headings anchors should be added
\t-ml  to give the maximum heading level on which to add numbers
\t-r   to give the real path to the source file\n";
}

$hdbasef = $ARGV[0];
shift;
if ($ARGV[0]) {
    $input = $ARGV[0];
    shift;
} else {
    $input = "-";
}
if ($ARGV[0]) {
    $output = $ARGV[0];
} else {
    $output = "-";
}
if (! $realpath) {
    $realpath = $input;
}

# copy file in memory
sub readfile {
    $buf = "";
    if (!open(INPUT, $_[0])) {
	print STDERR "$PROGNAME Error: Cannot open file: $_[0]\n";
	exit 1;
    }
    while (<INPUT>) {
	$buf .= $_;
    }
    close(INPUT);
}

# args: stag hnum heading etag
sub addanchor {
    if (($_[1] >= $startlvl) && ($_[1] <= $dbmaxlvl)) {
	$key = "$realpath$n";
	$n++;
	$data = $hdbase{$key};
	if ($data) {
	    $content = $_[2];
	    ($h, $hnum, $heading, $anchor) = split(";", $data, 4);
	    if ($h == $_[1]) {
		if ($addnums && ($maxlvl == 0) || ($h <= $maxlvl)) {
		    if ($h == 1 && $h1prefix ne "") {
			$num = "$h1prefix $hnum:";
		    } else {
			$num = "$hnum";
		    }
		    #Insert anchor from heading database.
		    if ($content =~ /<a[^>]+>/si) {
			# let's reuse it
			$anch = $&;
			unless ($anch =~ /name=\"?\S+\"?/si) {
			    $content =~ s/<a[\n \t]+/$&name=\"$anchor\" /si;
			}
			$content = "$num $content";
		    } else {
			$content = "<a name=\"$anchor\">$num</a> $content";
		    }
		} else {
		    # HACK!!!
		    # add a non breakable space in the anchor to work around
		    # broken browsers which don't support correctly empty
		    # anchors
		    #Insert anchor from heading database.
		    if ($content =~ /<a[^>]+>/si) {
			# let's reuse it
			$anch = $&;
			unless ($anch =~ /name=\"?\S+\"?/si) {
			    $content =~ s/<a[\n \t]+/$&name=\"$anchor\" /si;
			}
		    } else {
			$content = "$content <a name=\"$anchor\">&nbsp;</a>";
		    }
		}
	    }
	    return "$_[0]$content$_[3]";
	}
	print STDERR "Heading database out of date, could not find entry!
                  : $key\n";
    }
    return "$_[0]$_[2]$_[3]";
}


### main

# read heading database
readfile($hdbasef);
$_ = $buf;
$prevf = "";
$dbmaxlvl = 0;
while (/(.*?);(.*?);([0-9]*);([1-9A-Z].*?);(.*?)\n/sio) {
    $file = $1;
    $heading = $2;
    $h = int($3);
    $hnum = $4;
    $anchor = $5;
    if ($h > $dbmaxlvl) {
	$dbmaxlvl = $h;
    }
    if ($h >= $startlvl) {
	if ($file ne $prevf) {
	    $n = 0;
	    $prevf = $file;
	} else {
	    $n++;
	}
	$key = "$file$n";
	$hdbase{$key} = "$h;$hnum;$heading;$anchor";
    }
    $_ = $';
}

readfile($input);

# insert heading anchors
$headingp = "(<h([1-6]).*?>)(.*?)(</h[1-6]>)";
$n = 0;
$buf =~ s/$headingp/addanchor($1, $2, $3, $4)/sgieo;

# print out result
open(OUTPUT, "> $output");
print OUTPUT $buf;
close(OUTPUT);
