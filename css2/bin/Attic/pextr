#!/usr/local/bin/perl
# Extract entries from the CSS properties database
# The database has the following format:
# name;; values;; initial-value;; applies-to;; inherited;; percentages
# Special characters: 
#  1) Translate "*" into the words "all elements"
#  1.a) Translate "XX" into "not defined for shorthand properties"
#  2) "<name>" means the value is defined elsewhere. Translate to
#     <span class="value-inst-name">&lt;name&gt;</span>
#  3) "<'name'>" means the set of values is the same as for the
#      property with the same name. Translate to
#     <span class="propinst-name">&lt;'name'&gt;</span>     
#
# Ian Jacobs - ij@w3.org (Based on work by Arnaud Le Hors)
# $Id: pextr,v 1.1 1997-09-08 18:24:13 ian Exp $

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[0]) {
    print "Usage: $PROGNAME file [tgt_dir]\n";
    exit 1;
}

# copy file in memory
if (!open(input, $ARGV[0])) {
    print "$PROGNAME Error: Cannot open file: $ARGV[0]\n";
    exit 1;
}
$buf = "";
while (<input>) {
    $buf .= $_;
}
close(input);

$path = "";
if ($ARGV[1]) {
    $path = "$ARGV[1]/";
}

# regexps
$sp = "[ \t\n]*";		# whitespace
$patt = "$sp(.*?)$sp";
$blockst = "[/][*]";
$blocket = "[*][/]";

sub format_property {
$name = $_[0]; 
$values = $_[1]; 
$init = $_[2];
$applies = $_[3];
$inherited = $_[4];
$percentages = $_[5];
print output "<DIV class=\"propdef\">\n";
print output "<H4 class=\"propname\">\n";
print output "<a name=\"propdef-$name\">'$name'</a>\n";
print output "</H4>\n";
print output "<TABLE class=\"propinfo\">\n";
&format_name($name);
&format_values($values);
&format_init($init);
&format_applies($applies);
&format_inherited($inherited);
&format_percentages($percentages);
print output "</TABLE>\n";
print output "</DIV>\n\n";
}  

sub format_name {
print output "<TR><TH align=\"right\">Property name:";
print output "<TD><span class=\"index-def\" title=\"'$_[0]'\">\'$_[0]\'</span></TR>\n";
}

sub format_values {
$values = $_[0];
$values =~ s/<([^>']*)>/<span class=\"value-inst-$1\">&lt;$1&gt;<\/span>/g;
$values =~ s/<[']([^']*)[']>/<span class=\"propinst-$1\">&lt;'$1'&gt;<\/span>/g;
print output "<TR><TH align=\"right\">Value:<TD>$values</TR>\n";
}

sub format_init {
$init = $_[0];
$init =~ s/XX/not defined for shorthand properties/g;
$init =~ s/<([^>']*)>/<span class=\"value-inst-$1\">&lt;$1&gt;<\/span>/g;
$init =~ s/<[']([^']*)[']>/<span class=\"propinst-$1\">&lt;'$1'&gt;<\/span>/g;
print output "<TR><TH align=\"right\">Initial:<TD>$init</TR>\n";
}

sub format_applies {
$applies = $_[0];
$applies =~ s/\*/all elements/g;
print output "<TR><TH align=\"right\">Applies to:<TD>$applies</TR>\n";
}

sub format_inherited {
print output "<TR><TH align=\"right\">Inherited:<TD>$_[0]</TR>\n";
}

sub format_percentages {
print output "<TR><TH align=\"right\">Percentage values:<TD>$_[0]</TR>\n";
}

# extract every possible block
$_ = $buf;
while (/$blockst$patt;;$patt;;$patt;;$patt;;$patt;;$patt$blocket/s) {
    # Set parameters first (before any modifications)
    $placeholder = $';
    $output = "$path$1.srb";
    print "\textracting $output\n";
    open(output, "> $output");
    &format_property($1, $2, $3, $4, $5, $6);
    close(output);
    $_ = $placeholder;
}
