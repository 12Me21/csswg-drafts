#!/usr/local/bin/perl
# Html Include Processor:
#
# search for tag <include src=file ...>
# and replace it by the content of "file"
#
# Arnaud Le Hors - lehors@w3.org
# $Id: hipp,v 1.1 1997-07-29 17:14:40 ijacobs Exp $

# init search path
$paths[0] = ".";
# parse include flags and augment search path
while ($_ = $ARGV[0], /^-I(.*)/) {
    $paths[@paths] = $1;
    shift;
}

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[0]) {
    print "Usage: $PROGNAME [-Idir1 -Idir2 ...] file.src [trgt]\n";
    exit 1;
}
$file = $ARGV[0];
if ($ARGV[1]) {
    $output = $ARGV[1];
} else {
    $output = "-";
}

# regexp
$inctag = "<!--[ \t\n]*#include[ \t\n]*src=\"?([^ \t\n-\"]*).*?-->";

# open file using the given search path
sub openfile {
    if ($_[0] eq "-") {
	open(INPUT, "-");
	return INPUT;
    }
    foreach $p (@paths) {
	$path = "$p/$_[0]";
	if (open(INPUT, $path)) {
	    return INPUT;
	}
    }
    return ();
}

# recursive sub routine extending include tags
# args: file exitflag
sub processf {
    # copy file in memory
    if (!openfile($_[0])) {
	print STDERR "$PROGNAME Error: Cannot open file: $_[0]\n";
	if ($_[1] == 1) {
	    exit 1;
	} else {
	    return "";
	}
    }
    my $buf = "";
    while (<INPUT>) {
	$buf .= $_;
    }
    close(INPUT);
    # then substitute include tags by the content of file they reference
    $buf =~ s/$inctag/processf($1,0)/sgieo;
    return $buf;
}

$buf = processf($file,1);
open(OUTPUT, "> $output");
print OUTPUT $buf;
close(OUTPUT);
