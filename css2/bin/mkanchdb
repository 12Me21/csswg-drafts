#!/usr/local/bin/perl
# Extract all the anchors that have a name of the form: "<prefix>-<name>"
# and build a database for it.
#
# Arnaud Le Hors - lehors@w3.org
# Modified by Bert Bos <bert@w3.org>
# $Id: mkanchdb,v 2.0 1998-02-02 18:52:51 bbos Exp $

use lib 'bin';
use utils;

$PROG = substr($0, rindex($0, "/") + 1);
$USAGE = "Usage: $PROG prefix dbase file [file...]\n";


### main

($prefix = $ARGV[0]) || die $USAGE;
shift;
($dbase = $ARGV[0]) || die $USAGE;
shift;

dbmopen(%anchors, $dbase, 0666) || die "$PROG: cannot open database $dbase\n";

foreach $file (@ARGV) {
    my $buf = readfile($file);	# Read file
    $buf =~ s/<!--.*?-->//sgio;	# Remove comments
    my $hfil = $file;		# Change extension
    $hfil =~ s/\.sr.$/.html/io;
    # Loop over all anchors, store them in database, prefixed with filename
    while ($buf =~ /<a\s+[^>]*?name\s*=\s*[\"\']?($prefix[^\s\"\'>]+)[\"\']?.*?>/sio) {
	$buf = $';
	$anch = "$hfil#$1";
	if (($anchors{$1} ne "") && ($anchors{$1} ne $anch)) {
	    warn "$PROG: duplicated index \"$1\":
\t\"$anchors{$1}\" and \"$anch\"";
	}
	$anchors{$1} = $anch;
    }
}
