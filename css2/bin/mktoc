#!/usr/local/bin/perl
# Generate a table of contents plus a database of headings
# When an HTML comment is found right before the end tag of a header its
# content is added as a description note to the TOC like this:
#   1. Some header - and its related comment
#
# Arnaud Le Hors - lehors@w3.org
# $Id: mktoc,v 1.5 1997-07-31 15:38:28 ijacobs Exp $

$PROGNAME = substr($0, rindex($0, "/") + 1);

if ($#ARGV < 2) {
    print STDERR "Usage: $PROGNAME toc tocdb src1 src2 ...\n";
    exit 1;
} else {
    $tocf = $ARGV[0];
    shift;
    $tocdb = $ARGV[0];
    shift;
}

# copy file in memory
sub readfile {
    $buf = "";
    if (!open(INPUT, $_[0])) {
	print STDERR "$PROGNAME Error: Cannot open file: $_[0]\n";
	return;
    }
    while (<INPUT>) {
	$buf .= $_;
    }
    close(INPUT);
}

sub hnuminit {
    @n = ();
    @ol = ();
    $ol[0] = 0;
}

sub hnum {
# args: $n, $l
    $hn = $_[0] + $_[1] - 1;
    for ($i = $#n; $i > $hn; $i--) {
	if ($ol[$i] != 0) {
#	    print OUTPUT "</ul>\n";
	    $ol[$i] = 0;
	}
	$n[$i] = 0;
    }
    if ($hn >= 0 && $ol[$hn] == 0) {
#	print OUTPUT "<ul compact type=square>\n";
	$ol[$hn] = 1;
    }
    $n[$hn]++;
    $num = "$n[0]";
    for ($i = 1; $i <= $hn; $i++) {
	$num .= ".$n[$i]";
    }
    return $num;
}

# remove every possible anchor
sub cleanup {
    $text = $_[0];
    $text =~ s/<a(.*?)>//sgi;
    $text =~ s/<\/a>//sgi;
    $text =~ s/[ \t]*$//sgi;
    return $text;
}


### main

# search for all the headings
$headingp = "<h([1-6]).*?>(.*?)(?:<!--(.*?)-->)?</h[1-6]>";

open(DBASE, "> $tocdb");
open(OUTPUT, "> $tocf");
hnuminit();
foreach $file (@ARGV) {
    readfile($file);
    # compute correct level based on path depth and filename
    @lvls = split("/", $file);
    $l = $#lvls;
    $_ = $file;
    # change extension
    $hfil = $file;
    $hfil =~ s/\.src/\.html/;
    # seek headings
    $_ = $buf;
    $lastlevel = ();
    while (/$headingp/sio) {
	$h = int($1);
	$t = $2;
	# compute section number
	$num = hnum($h, $l);
	if ($h == 1) {	# if H1 go to the top of the page and set rel
	    $url = "$hfil";
	    $rel= " rel=\"chapter\"";
	} else {
	    $url = "$hfil#h-$num";
	    $rel = "";
	}
	$txt = cleanup($t);
	if ($h == 1) {
	    print OUTPUT 
		"<P><a href=\"$url\"$rel><strong>$num $txt</strong></a>\n"; 
	    $lastlevel = 1;
	} elsif ($h == 2) {
	    print OUTPUT "<BR><a href=\"$url\"$rel>$num $txt</a>\n";
	    $lastlevel = 2; 
	} elsif ($h == 3) {
	    print OUTPUT 
		"<BR>&nbsp;&nbsp;&nbsp;<a href=\"$url\"$rel>$num $txt</a>\n";
	    $lastlevel = 3; 
	} else {
	    if ($lastlevel < 4) {
		print OUTPUT "<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
		} else {
		print OUTPUT ", &nbsp;"
		}
	    print OUTPUT "<a href=\"$url\"$rel>$txt</a>";
	    $lastlevel = 4;
	}
	#Print comment about section contents.
	if ($3) {
	    print OUTPUT " <em>-$3</em>";
	}
	# dbase format: file;headingtext;h;hnum
	print DBASE "$file;$t;$h;$num\n";
	$_ = $';
    }
}
hnum(0, 0);			# close all open lists
close(OUTPUT);
close(DBASE);
