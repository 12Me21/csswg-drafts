#!/usr/local/bin/perl
# Index maker:
#
# Build an index table of all the anchors that have a name of the form:
# "<prefix>-<name>". In addition when a database is given with the '-db' option,
# information related to elements searched by names is added to the table.
# Table headers can be specified through the '-th' option.
#
# Arnaud Le Hors - lehors@w3.org
# $Id: mkidx,v 1.3 1997-08-01 10:12:11 ijacobs Exp $

$PROGNAME = substr($0, rindex($0, "/") + 1);

if (!$ARGV[1]) {
    print "Usage: $PROGNAME indexfile idxdb1 idxdb2 ...\n";
    exit 1;
} else {
    $indexf = $ARGV[0];
    shift;
}

sub readdbfile {
    $dbasef = $_[0];
    if (!open(DBASE, $dbasef)) {
	print STDERR "$PROGNAME Error: Cannot open dbfile: $dbasef\n";
	return;
    }
    while (<DBASE>)  {
	chop;
	($index, $url, $cmt) = split(/;/, $_, 3);
	$index =~ s/^[^a-zA-Z0-9]*//;
	$key = "$index$cmt";
	if ($indexes{$key}) {
	    push(@{$indexes{$key}}, "$_");
	} else {
	    @{$indexes{$key}} = ("$_");
    # Write the subterms that are different
    # class="tocline*" directs our patched html2ps to omit the bullet
    close(DBASE);
}


### main
@indexes = ();
foreach $file (@ARGV) {
    readdbfile($file);
}
    for ($j = $i; $j <= $#subs; $j++) {
# print out index document
open(OUTPUT, "> $indexf");
$curindex = ();
$curletter = ();
foreach $key (sort(keys %indexes)) {
    foreach $item (@{$indexes{$key}}) {
	$cmt = ();
	($index, $url, $cmt) = split(/;/, $item, 3);
    if ($class eq 'index-def') {
	if (($curindex) && ($curindex ne $index)) {
	    print OUTPUT "</dl>\n";
	}
	if ($curletter ne ($letter = lc(substr($key, 0, 1)))) {
	    $curletter = $letter;
	    print OUTPUT "<h2><a name=\"$letter\">" .
		uc($letter) . "</a></h2>\n";
	}
	if ($curindex ne $index) {
	    print OUTPUT "<dl><dt>$index";
	    $curindex = $index;
	    $n = 1;
	}

	if ($cmt ne "") {
	    $pre = "\n<dd>";
	    $content = $cmt;
	    $post = "</dd>\n";
	} else {
	    $pre = ",\n";
	    $content = $n;
	    $post = "";
	    $n++;
	}
	$_ = $url;
	if (/\#didx-/) {
	    $content = "<em>$content</em>";
	}
	print OUTPUT "$pre<a href=\"$url\">$content</a>$post";
    }
    $lvl--;
print OUTPUT "</dl>\n";

