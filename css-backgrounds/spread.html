<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8" />
<title>box-shadow spread rounding</title>
<style>
body {
	font: 100% sans-serif;
}

.box {
	display: inline-block;
	background: orange; /* box-shadow color */
}

	.box > div {
		background: yellow;
		width: 100px;	
		height: 100px;
	}
	
label {
	display: block;
	margin-bottom: 15px;
}

form {
	float: left;
	margin-right: 20px;
}

input, select {
	font: inherit;
	vertical-align: top;
}
</style>

</head>
<body>

<h1>box-shadow spread rounding</h1>

<form>
	<label>
		Spread:
		<input type="range" id="spread" value="40" />
	</label>
	
	<label>
		Radius:
		<input type="range" id="bradius" value="5" />
	</label>
	
	<!--<label>
		Constant:
		<input type="number" id="constant" value="4" />
	</label>-->
	
	<label>
		Algorithm:
		<select id="algorithm" size="4">
			<option value="old">Old</option>
			<option value="arc">Arc</option>
			<option value="hyp">Hyperbolic</option>
			<option value="cubic" selected>Cubic</option>
		</select>
	</label>
</form>

<div class="box">
	<div></div>
</div>

<script>
function $$(expr, con) {
	return Array.prototype.slice.call((con || document).querySelectorAll(expr));
}

// Make each ID a global variable
// Many browsers do this anyway (itâ€™s in the HTML5 spec), so it ensures consistency
$$('[id]').forEach(function(element) { window[element.id] = element; });

function Box(box) {
	this.box = box;
	this.inner = box.firstElementChild;
}

Box.prototype = {
	set borderRadius(value) {
		value = Math.min(value, this.inner.offsetHeight);
		
		this._borderRadius = value;
		
		this.inner.style.borderTopRightRadius = value + 'px';
		this.box.style.borderTopRightRadius = Box.spreadRounding(this.borderRadius, this._spread) + 'px';
	},
	
	get borderRadius() {
		return this._borderRadius || 0;
	},
	
	set spread(value) {
		this._spread = value;
		
		this.inner.style.margin = value + 'px';
		this.box.style.borderTopRightRadius = Box.spreadRounding(this.borderRadius, value) + 'px';
	},
	
	get spread() {
		return this._spread;
	},
	
	redraw: function () {
		this.borderRadius = this._borderRadius;
		this.spread = this._spread;
	}
};

Box.constant = 4;

Box.ratios = {
	old: function(x) {
		return 1;
	},
	
	arc: function(x) {
		return x < 1? Math.sqrt(1 - (x-1)*(x-1)) : 1;
	},
	
	hyp: function(x) {
		return 1-1/(Box.constant*x+1);
	},
	
	cubic: function(x) {
		return x < 1? 1 + Math.pow(x-1, 3) : 1;
	}
};

Box.spreadRounding = function(r, spread) {
	var ratio = Box.ratio(r/spread);
	
	return r + spread * ratio;
};

Box.redrawAll = function() {
	$$('.box').forEach(function (box) {
		box.box.redraw();
	});
};

$$('.box').forEach(function (box) {
	box.box = new Box(box);
});

spread.oninput = spread.onchange = function() {
	var spread = this.title = this.value;
	
	$$('.box').forEach(function (box) {
		box.box.spread = +spread;
	});
};

bradius.oninput = bradius.onchange = function() {
	var radius = this.title = this.value;
	
	$$('.box').forEach(function (box) {
		box.box.borderRadius = +radius;
	});
};

algorithm.onchange = function () {
	Box.ratio = Box.ratios[this.value];
	
	Box.redrawAll();
};

algorithm.onchange();

//constant.oninput = function() {
//	Box.constant = +this.value;
//	
//	Box.redrawAll();
//};

// init
$$('input').forEach(function (input) {
	input.oninput && input.oninput();
	input.onchange && input.onchange();
	input.onclick && input.onclick();
});

Box.redrawAll();
</script>

</body>
</html>