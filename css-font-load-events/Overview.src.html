<h1>CSS Font Load Events Module Level 3</h1>

<pre class='metadata'>
Shortname: css-font-load-events
Level: 3
Status: ED
ED: http://dev.w3.org/csswg/css-font-load-events/
TR: http://www.w3.org/TR/css-font-load-events-3/
Editor: Tab Atkins Jr., Google, http://xanthir.com/contact/
Editor: John Daggett, Mozilla, jdaggett@mozilla.com
Abstract: This CSS module describes events and interfaces used for dynamically loading font resources.
Link Defaults: css-fonts-3 (descriptor) src
Ignored Terms: domerror, notfounderror, networkerror, canvasrenderingcontext2d, font, event, eventinit, eventtarget
</pre>

<style>
#bolderlighter {
	width: 40%;
}

#bolderlighter th {
	text-align: center;
}

#fontformats td, #eventhandlers td, #fontformats th, #eventhandlers th {
	padding-right: 2em;
	text-align: left;
}

#authors dd {
	margin-bottom: 0;
}

#fontstylematchingalg {
	list-style-type: lower-alpha;
}

#fontmatchingalg ul, #fontmatchingalg ol {
	margin-top: 0.8em;
}

#fontmatchingalg li + li {
	margin-top: 0.8em;
}

div.figure {
	page-break-inside: avoid;
}

div.featex {
	width: 700px;
}

div.featex img {
	margin: auto;
	display: block;
}

ol ol {
	list-style-type: lower-alpha;
}

.idl-code {
	font-weight: bold;
	color: #c50;
	font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
	font-size: .9em;
}
</style>


<h2 id="introduction">
Introduction</h2>

	<p class='issue'>
		Fill in intro.

<h2 id="font-load-events">
Font Load Events</h2>

	Since fonts defined via ''@font-face'' rules are loaded on demand,
	pages may need to know precisely when fonts have completed
	downloading before measuring text elements on the page or to
	show some form of interim user interface state.

<h3 id="document-fontloader">
Extension to the <code>document</code> interface</h3>

	To allow font loading to be tracked explicitly within content
	the following event target is added to the <code>document</code> of the page:

	<pre class="idl">
		partial interface Document {
			readonly attribute FontLoader <dfn attribute for=Document>fontloader</dfn>;
		};
	</pre>

<h3 id="fontloader-interface">
The <code>FontLoader</code> Interface</h3>

	<pre class="idl">
		dictionary <dfn dictionary>CSSFontFaceLoadEventInit</dfn> : <a dictionary>EventInit</a> {
			CSSFontFaceRule <dfn dictmember for=CSSFontFaceLoadEventInit>fontface</dfn> = null;
			DOMError <dfn dictmember for=CSSFontFaceLoadEventInit>error</dfn> = null;
		};

		[Constructor(DOMString type, optional <a dictionary>CSSFontFaceLoadEventInit</a> eventInitDict)]
		interface <dfn interface>CSSFontFaceLoadEvent</dfn> : <a interface>Event</a> {
			readonly attribute CSSFontFaceRule <dfn attribute for=CSSFontFaceLoadEvent>fontface</dfn>;
			readonly attribute DOMError? <dfn attribute for=CSSFontFaceLoadEvent>error</dfn> = null;
		}

		interface <dfn interface>FontLoader</dfn> : <a interface>EventTarget</a> {

			// -- events for when loading state changes
			attribute <a interface>EventHandler</a> <dfn attribute for=FontLoader>onloading</dfn>;
			attribute <a interface>EventHandler</a> <dfn attribute for=FontLoader>onloadingdone</dfn>;

			// -- events for each individual font load
			attribute <a interface>EventHandler</a> <dfn attribute for=FontLoader>onloadstart</dfn>;
			attribute <a interface>EventHandler</a> <dfn attribute for=FontLoader>onload</dfn>;
			attribute <a interface>EventHandler</a> <dfn attribute for=FontLoader>onerror</dfn>;

			// check and start load if appropriate
			// and fulfill promise when all loads complete
			Promise <a method for=FontLoader title="loadFont()">loadFont</a>(DOMString font, optional DOMString text = " ");

			// return whether all fonts in the fontlist are loaded
			// (does not initiate load if not available)
			boolean <a method for=FontLoader title="checkFont()">checkFont</a>(DOMString font, optional DOMString text = " ");

			// async notification that font loading and layout operations are done
			Promise <a method for=FontLoader title="ready()">ready</a>();

			// loading state, true while one or more fonts loading, false otherwise
			readonly attribute boolean <dfn attribute for=FontLoader>loading</dfn>;
		};
	</pre>

	Because font families defined with <code>@font-face</code> rules are
	loaded only when they are used, content sometimes needs to understand
	when the loading of fonts occurs.  Authors can use the events and methods
	defined here to allow greater control over actions that are dependent upon
	the availability of specific fonts.

	The term <dfn>font load</dfn> is used below to indicate when the
	loading of content for a given <code>@font-face</code> rule completes.
	An ''@font-face'' rule may list multiple alternate resources
	within the 'src' descriptor, including references to local fonts, but
	the term font load only refers to the loading of the finally selected
	resource for a given rule, not to the loading of each individual
	resource.

	<p class="issue">
		Given that the FontLoader object is defined to be attached to the
		document, how will canvas worker threads load fonts?

<h4 id='fontloader-events'>
Events</h4>

	Font load events are grouped into two general categories, events
	associated with a group of fonts loading (<dfn event for="FontLoader">loading</dfn>,
	<dfn event for="FontLoader">loadingdone</dfn>) or finer-grained events associated
	with each individual font loaded (<dfn event for="FontLoader">loadstart</dfn>,
	<dfn event for="FontLoader">load</dfn>, <dfn event for="FontLoader">error</dfn>).

	The following are the event handlers (and their corresponding event handler event types)
	that must be supported by <code>FontLoader</code> objects as IDL attributes:

	<table class="data" id="eventhandlers">
		<thead>
			<tr>
				<th>Event handler
				<th>Event handler event type
		<tbody>
			<tr>
				<th><a attribute>onloading</a>
				<td><a event>loading</a>
			<tr>
				<th><a attribute>onloadingdone</a>
				<td><a event>loadingdone</a>
			<tr>
				<th><a attribute>onloadstart</a>
				<td><a event>loadstart</a>
			<tr>
				<th><a attribute>onload</a>
				<td><a event>load</a>
			<tr>
				<th><a attribute>onerror</a>
				<td><a event>error</a>
	</table>

	To <dfn>fire a font load event</dfn> named <var>e</var> at a <a interface>FontLoader</a> target
	means to
	<a href="http://www.w3.org/TR/html5/webappapis.html#event-firing">fire a simple event</a> named <var>e</var>
	using the <a interface>CSSFontFaceLoadEvent</a> interface that also meets these conditions:

	<ol>
		<li>
			The <a attribute>fontface</a> attribute is initialized to the given <var>font
			face rule</var>.

		<li>
			The <a attribute>error</a> attribute is initialized to the given <var>error</var>, if one occurred during the font load.
	</ol>

	When the user agent determines that one or more fonts
	defined via ''@font-face'' rules in a document <var>doc</var>
	need to be loaded, it must run the following steps:

	<ol>
		<li>
			Let <var>font loader</var> be the value of the <a attribute>fontloader</a> attribute of <var>doc</var>.

		<li>
			Set the <code class="idl-code">loading</code> attribute of <var>font loader</var> to true.

		<li>
			<a>Fire a font load event</a> named <a event>loading</a> at <var>font loader</var>
			with <a attribute>fontface</a> set to the first ''@font-face'' rule.

		<li>
			When the user agent begins loading the first resource for a given <code>@font-face</code> rule, it must <a>fire a
			font load event</a> named <a event>loadstart</a> at <var>font loader</var>
			with <a attribute>fontface</a> set to the given ''@font-face'' rule.
	</ol>

	These steps imply that if fonts are loaded concurrently, the
	<a event>loading</a> event will fire just once, while
	the <a event>loadstart</a> event will be fired once
	for each ''@font-face'' rule whose load is initiated.
	User agents must only set the <a event>error</a>
	attribute of a font load event to a non-null value in the cases
	noted in this section.

	The term “font load” covers any of the resources listed in the
	'src' descriptor, including local fonts.  When multiple resources are
	listed, the “font load” is the first resource in the list to
	successfully load or the error that occurs on the last resource for
	which a load is attempted.

	When the user agent completes each font load for a document <var>doc</var>,
	it must run the following steps:

	<ol>
		<li>
			Let <var>font loader</var> be the value of the <a attribute>fontloader</a> attribute of <var>doc</var>.

		<li>
			If a font data was successfully loaded and activated,
			<a>fire a font load event</a> named
			<a event>load</a> at <var>font loader</var> with
			<a attribute>fontface</a> set to the ''@font-face''
			rule for which the font data was loaded.

		<li>
			Otherwise, <a>fire a font load event</a>
			named <a event>error</a>
			at <var>font loader</var> with <a attribute>fontface</a>
			set to the ''@font-face'' rule for which the error occurred.
			If the font data can't be loaded <a attribute>error</a>
			is set to one of the standard <a interface>DOMError</a> types (e.g. <a event>NotFoundError</a>,
			<a event>NetworkError</a>).  If the font data was downloaded but invalid,
			then <a attribute>error</a> is set to <code>"InvalidFontDataError"</code>.
			If several resources are listed in the 'src' descriptor, the
			error that caused the last font resource in the list to fail must be used.
	</ol>

	When the user agent completes the final font load for document
	<var>doc</var>, after all pending layout operations that might affect
	font selection have completed and no font loads are pending, it must
	run the following steps:

	<ol>
		<li>
			Let <var>font loader</var> be the value of the <a attribute>fontloader</a> attribute of <var>doc</var>.

		<li>
			Set the <a attribute>loading</a> attribute of <var>font loader</var> to false.

		<li>
			<a>Fire a font load event</a>
			named <a event>loadingdone</a>
			at <var>font loader</var> with <a attribute>fontface</a>
			set to the ''@font-face'' rule of the last font loaded.
	</ol>

	For example, if three fonts are loaded at the same time, a
	<a event>loading</a> event followed by three <a event>loadstart</a> events and three
	<a event>load</a> or <a event>error</a> events, followed by a
	<a event>loadingdone</a> event will occur.

	<p class="issue">
		Errors will go "unreported" when using the general category of font
		load events (i.e. <a event>loading</a> and <a event>loadingdone</a>).
		This seems fine but need to confirm this.

<h4 id='fontloader-methods'>
Methods</h4>

	The methods <a>loadFont()</a> and <a>checkFont()</a>
	will determine whether all fonts in the given font list have been
	loaded and are available.  If all fonts are available,
	<a>checkFont()</a> will return true, or false if one or more
	fonts are not available.  In the case of <a>loadFont()</a>, if any
	fonts are downloadable fonts and have not already been loaded, the
	user agent will initiate the load of each of these fonts.

<h5 id='loadfont-method'>
The <code>loadFont()</code> method</h5>

	The <dfn method for="FontLoader" title="loadFont()">loadFont(<dfn argument>font</dfn>, <dfn argument>text</dfn>)</dfn> method must use these steps:

	<p class='issue'>
		I'm just sketching the promise terminology here.
		Need to fill it in with the real stuff.

	<ol>
		<li>
			Create a new Promise and return it.
			Run the remaining steps in this algorithm asynchronously.

		<li>
			Parse the value of the <a argument for='loadFont()'>font</a> argument, 
			using the CSS value syntax of the 'font' property.

		<li>
			If a syntax error occurs,
			reject the promise with a SyntaxError.

		<li>
			Otherwise, let <var>font family list</var> be the set of families and
			<var>font style</var> be the other font style attributes.

		<li>
			For each family in <var>font family list</var>, 
			use the font matching rules to select the font faces that match the <var>font style</var>.
			In the case where these are font faces defined via ''@font-face'' rules, 
			the use of 'unicode-range' means that this may be more than just a single font face.

		<li>
			Remove from the set of font faces all faces that have defined 'unicode-range'
			values that don't intersect the range of character values in the <a argument for='loadFont()'>text</a>
			argument and set this to be the <var>font load list</var>.

		<li>
			If the <var>font load list</var> contains no font faces,
			reject the promise with XXX.

		<li>
			For all of the font faces in the <var>font load list</var>, initiate the load of any font that has
			not already been loaded and return.

		<li>
			When all fonts in the <var>font load list</var> have been loaded, 
			resolve the promise appropriately.
			If all fonts loaded successfully, 
			accept the promise with XXX.

			<p>
				If an error occurred with any one of the fonts in the <var>font load list</var>,
				reject the promise with XXX.
	</ol>

<h5 id='checkfont-method'>
The <code>checkFont()</code> method</h5>

	The <dfn method for="FontLoader" title="checkFont()">checkFont(<dfn argument>font</dfn>, <dfn argument>text</dfn>)</dfn> method must use these steps:

	<ol>
		<li>
			Parse the value of the <a argument for="checkFont()">font</a> parameter,
			using the CSS value syntax of the 'font' property.

		<li>
			If a syntax error occurs, return <code>false</code>.

		<li>
			Otherwise, let <var>font family list</var> be the set of families and
			<var>font style</var> be the other font style attributes.

		<li>
			For each family in <var>font family list</var>, 
			use the font matching rules to select the font faces that match the <var>font style</var>.  
			In the case where these are font faces defined via ''@font-face'' rules, 
			the use of 'unicode-range'means that this may be more than just a single font face.

		<li>
			Remove from the set of font faces all faces that have defined 'unicode-range'
			values that don't intersect the range of character values in the <a argument for="checkFont()">text</a>
			parameter and set this to be the <var>font load list</var>.

		<li>
			If the <var>font load list</var> contains no font faces, return <code class="idl-code">false</code>.

		<li>
			If all fonts in the <var>font load list</var> have already successfully been loaded,
			return <code>true</code>.  Otherwise, return <code>false</code>.
	</ol>

	The <a argument for="checkFont()">font</a> parameter of <a>checkFont()</a>
	and <a>loadFont()</a> both specify the list of fonts to load.  
	These values must be parsed using the same syntax as values for the CSS 'font' property,
	the same way the <a attribute>font</a> attribute of the <a interface>CanvasRenderingContext2D</a> is interpreted. [[!HTML5]]
	This yields a list of font families along with font style attributes.

<h5 id='ready-method'>
The <code>ready()</code> method</h5>

	Because the number of fonts loaded depends on the how many fonts are used for a given piece of text, 
	in some cases whether fonts need to be loaded or not may not be known.
	The <a>ready()</a> method returns a Promise which is fulfilled when the document is done loading fonts,
	which provides a way for authors to avoid having to keep track of which fonts have or haven't been loaded 
	before examining content which may be affected by loading fonts.

	Let <var>font loader</var> be the value of the <a attribute>fontloader</a> attribute of <var>doc</var>.
	The <var>font loader</var> contains a <dfn export>font readiness promise</dfn>,
	which is initially set to a fresh pending Promise.
	If, after the document has finished loading and completed its initial layout,
	no fonts need to be loaded,
	the <a>font readiness promise</a> is fulfilled with <var>font loader</var>.

	If, at any point,
	a <a event>loading</a> event is fired at <var>font loader</var>,
	the current <a>font readiness promise</a> is discarded,
	and a fresh pending promise is created and assigned to be the <a>font readiness promise</a>.
	If, at any point,
	a <a event>loadingdone</a> event is fired at <var>font loader</var>,
	the current <a>font readiness promise</a> is fulfilled with <var>font loader</var>.

	The <dfn method for="FontLoader" title="ready()">ready()</dfn> method
	must return the current <a>font readiness promise</a>.

	Note: Authors should note that a given <a>font readiness promise</a> is only fulfilled once,
	but further fonts may be loaded after it fulfills.
	This is similar to listening for a <a event>loadingdone</a> event to fire,
	but the callbacks passed to the <a method>ready()</a> promise will <strong>always</strong> get called,
	even when no font loads occur because the fonts in question are already loaded.  
	It's a simple, easy way to synchronize code to font loads 
	without the need to keep track of what fonts are needed and precisely when they load.

	Note: Note that the user agent may need to iterate over multiple font loads before the <a>font readiness promise</a> is fulfilled.
	This can occur with font fallback situations, 
	where one font in the fontlist is loaded 
	but doesn't contain a particular glyph 
	and other fonts in the fontlist need to be loaded.  
	The <a>font readiness promise</a> is only fulfilled after layout operations complete 
	and no additional font loads are necessary.

<h3 id="font-load-event-examples">
Font load event examples</h3>

	<div class="example">
		To show content only after all font loads complete:

		<pre>
			document.fontloader.ready().then(function() {
				var content = document.getElementById("content");
				content.style.visibility = "visible";
			});
		</pre>
	</div>

	<div class="example">
		Drawing text in a canvas with a downloadable font, explicitly
		initiating the font download and drawing upon completion:

		<pre>
			function drawStuff() {
				var ctx = document.getElementById("c").getContext("2d");

				ctx.fillStyle = "red";
				ctx.font = "50px MyDownloadableFont";
				ctx.fillText("Hello!", 100, 100);
			}

			document.fontloader.loadFont("50px MyDownloadableFont")
			                     .then(drawStuff, handleError);
		</pre>
	</div>

	<div class="example">
		A rich text editing application may need to measure text elements
		after editing operations have taken place.  Since style changes may
		or may not require additional fonts to be downloaded, or the fonts
		may already have been downloaded, the measurement procedures need to
		occur after those font loads complete:

		<pre>
			function measureTextElements() {
				// contents can now be measured using the metrics of
				// the downloadable font(s)
			}

			function doEditing() {
				// content/layout operations that may cause additional font loads
				document.fontloader.ready().then(measureTextElements);
			}
		</pre>
	</div>

	<div class="example">
		Unlike the per-font load events, the
		<a event>loadingdone</a> event only fires after all
		font related loads have completed <strong>and</strong> text has been
		laid out without causing additional font loads:

		<pre>
			@font-face {
				font-family: latin-serif;
				src: url(latinserif.woff) format("woff"); /* contains no kanji/kana */
			}

			@font-face {
				font-family: jpn-mincho;
				src: url(mincho.woff) format("woff");
			}

			body { font-family: latin-serif, jpn-mincho; }

			&lt;p>納豆はいかがでしょうか
		</pre>

		In this situation, the user agent first downloads “latinserif.woff”
		and then tries to use this to draw the Japanese text.  But because no
		Japanese glyphs are present in that font, fallback occurs and the font
		“mincho.woff” is downloaded.  Only after the second font is downloaded
		and the Japanese text laid out does the <a event>loadingdone</a>
		event fire.
	</div>


<h2 class="no-num" id="changes">Changes</h2>

<h3 class="no-num" id="changes-since-20130212">
Changes from the <a href="http://www.w3.org/TR/2013/WD-css3-fonts-20130212/">February 2013 CSS3 Fonts Working Draft</a></h3>

	Major changes include:

	<ul>
		<li>Add details of font load errors.

		<li>Switched to a promise-based design for loadFont() and ready().

		<li>Renamed notifyWhenFontsReady() to ready().
	</ul>

<h2 class=no-num id=acknowledgments>
Acknowledgments</h2>

	Several members of the Google Fonts team provided helpful feedback on font load events,
	as did Boris Zbarsky, Jonas Sicking and ms2ger.