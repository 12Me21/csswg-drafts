<!--

Issues:
	bidi
	box layout/sizing

Redo all examples with consistent font. (M+ 2p?)

-->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>CSS Ruby Module Level 1</title>
	<link rel=contents href="#contents">
	<link rel=index href="#index">
	<link rel="stylesheet" type="text/css" href="../default.css">
	<link href="../csslogo.ico" rel="shortcut icon" type="image/x-icon">
	<link rel="stylesheet" type="text/css" href="http://www.w3.org/StyleSheets/TR/W3C-[STATUS].css">
</head>

<body class="h-entry">

<div class="head">
<!--logo-->

<h1 class="p-name">CSS Ruby Module Level 1</h1>

<h2 class="no-num no-toc">[LONGSTATUS] <time class="dt-updated" datetime="[CDATE]">[DATE]</time> <!-- for HTML4 doctype: <span class="value-title" title="[CDATE]">[DATE]</span></span> --> </h2>
<dl>
	<dt>This version:
		<dd><a class="u-url" href="[VERSION]">[VERSION]</a>

	<dt>Latest version:
		<dd><a href="http://www.w3.org/TR/[SHORTNAME]/">http://www.w3.org/TR/css3-ruby/</a>

	<dt>Editor's draft:
		<dd><a href="http://dev.w3.org/csswg/[SHORTNAME]/">http://dev.w3.org/csswg/[SHORTNAME]/</a>
		(<a href="https://dvcs.w3.org/hg/csswg/log/tip/[SHORTNAME]/Overview.src.html">change log</a>)

	<dt>Previous version:
		<dd><a href="http://www.w3.org/TR/2011/WD-css3-ruby-20110630/">
		http://www.w3.org/TR/2011/WD-css3-ruby-20110630/</a>

	<dt>Issue Tracking:</dt>
		<dd><a rel="issues" href="http://www.w3.org/Style/CSS/Tracker/products/FIXME">http://www.w3.org/Style/CSS/Tracker/products/FIXME</a>

	<dt>Feedback:</dt>
		<dd><a href="mailto:www-style@w3.org?subject=%5BSHORTNAME%5D%20feedback"
				 >www-style@w3.org</a> 
				 with subject line &ldquo;<kbd>[[SHORTNAME]] 
				 <var>&hellip; message topic &hellip;</var></kbd>&rdquo;
				 (<a rel="discussion" href="http://lists.w3.org/Archives/Public/www-style/"
					 >archives</a>)

	<dt>Editors:
		<dd class="p-author h-card vcard">
			<a class="p-name fn u-url url" rel="author"
				 href="http://fantasai.inkedblade.net/contact">Elika J. Etemad</a>,
			<a class="p-org org h-org" href="http://www.mozilla.org/">Mozilla</a>
		<dd class="p-author h-card vcard">
			<a class="p-name fn u-url url" rel="author"
				 href="mailto:koji.a.ishii@mail.rakuten.com">Koji Ishii</a>,
			<span class="p-org org">Rakuten, Inc.</span>
		<dd class="p-author h-card vcard">
			<a class="p-name fn u-url url" rel="author"
				 href="mailto:ishida@w3.org">Richard Ishida</a>,
			<span class="p-org org">W3C</span>

	<dt>Former editors:
		<dd>Michel Suignard, Microsoft
		<dd>Marcin Sawicki, Microsoft
</dl>

<!--copyright-->

<hr title="Separator for header">
</div>

<h2 class="no-num no-toc" id="abstract">Abstract</h2>

	<p>
	<span class="p-summary">
		“Ruby” are short runs of text alongside the base text,
		typically used in East Asian documents to indicate pronunciation
		or to provide a short annotation.
		This module describes the rendering model and formatting controls
		related to displaying ruby annotations in CSS.
	</span>

	<a href="http://www.w3.org/TR/CSS/">CSS</a> is a language for describing
	the rendering of structured documents (such as HTML and XML) on screen, on
	paper, in speech, etc.

<h2 class="no-num no-toc" id="status">Status of this document</h2>

<!--status-->

<p>The following features are at risk: &hellip;

<h2 class="no-num no-toc" id="contents">
Table of Contents</h2>

<!--toc-->

<h2 id="intro">
Introduction</h2>

	<p><em>This section is not normative.</em>

<h3 id="placement">
Module interactions</h3>

	<p>This module extends the inline box model of CSS Level 2 [[!CSS21]]
	to support ruby.

	<p>None of the properties in this module apply to the <code>::first-line</code> or
	<code>::first-letter</code> pseudo-elements.

<h3 id="values">
Values</h3>

	<p>This specification follows the
	<a href="http://www.w3.org/TR/CSS21/about.html#property-defs">CSS property
	definition conventions</a> from [[!CSS21]]. Value types not defined in
	this specification are defined in CSS Level 2 Revision 1 [[!CSS21]].
	Other CSS modules may expand the definitions of these value types: for
	example [[CSS3VAL]], when combined with this module, expands the
	definition of the <var>&lt;length&gt;</var> value type as used in this specification.</p>

	<p>In addition to the property-specific values listed in their definitions,
	all properties defined in this specification also accept the
	<a href="http://www.w3.org/TR/CSS21/cascade.html#value-def-inherit">inherit</a>
	keyword as their property value. For readability it has not been repeated
	explicitly.

<h3 id="conventions">
Document conventions</h3>

	<p>Many typographical conventions in East Asian typography depend
	on whether the character rendered is wide (CJK) or narrow (non-CJK).
	There are a number of illustrations in this document
	for which the following legend is used:

	<dl>
		<dt><img alt="Symbolic wide-cell glyph representation" width="39" height="39" src="images/fullwidth.gif">
		<dd>Wide-cell glyph (e.g. Han) that is the <var>n</var>th character in the text run.
		They are typically sized to 50% when used as annotations.
		<dt><img alt="Symbolic narrow-cell glyph representation" width="19" height="39" src="images/halfwidth.gif">
		<dd>Narrow-cell glyph (e.g. Roman) which is the <var>n</var>th glyph in the text run.
	</dl>

	<p>The orientation which the above symbols assume in the diagrams
	corresponds to the orientation that the glyphs they represent
	are intended to assume when rendered by the user agent.
	Spacing between these characters in the diagrams is incidental,
	unless intentionally changed to make a point.

<h3 id="ruby-def">
What is ruby?</h3>

	<p><dfn>Ruby</dfn> is the commonly-used name for a run of text
	that appears alongside another run of text (referred to as the “base”)
	and serves as an annotation or a pronunciation guide associated with that run of text.

	<p>The following figures show two examples of Ruby,
	a simple case and one with more complicated structure.

	<div class="example">
		<p>In this first example, a single annotation is used to annotate the base text.
		<div class="figure">
			<p><img src="images/licence.png"
			        alt="Example of ruby applied on top of a Japanese expression">
			<p class="caption">Example of ruby used in Japanese (simple case)
		</div>
		<p>In Japanese typography, this case is sometimes called
		<i lang="ja">taigo</i> ruby or group-ruby (per-word ruby),
		because the annotation as a whole is associated
		with multi-character word (as a whole).
	</div>

	<div class="example">
		<p>In this second example,
		two levels of annotations are attached to a base sequence:
		the hiragana characters on top refer to the pronunciation of each of the base kanji characters,
		while the words “Keio” and “University” on the bottom are annotations describing the English translation.
		<div class="figure">
			<p><img src="images/ruby-univ.gif"
			        alt="Example showing complex ruby with annotation text over and under the base characters">
			<p class="caption">Complex ruby with annotation text over and under the base characters
		</div>
		<p>
		<p>Notice that to allow correct association between the hiragana characters and 
		their corresponding Kanji base characters,
		the spacing between these Kanji characters is adjusted.
		(This happens around the fourth Kanji character in the figure above.)
		To avoid variable spacing between the Kanji characters in the example above
		the hiragana annotations can be styled as a <i>collapsed annotation</i>,
		which will look more like the group-ruby example earlier.
		However because the base-annotation pairings are recorded in the ruby structure,
		if the text breaks across lines, the annotation characters will stay
		correctly paired with their respective base characters.
	</div>

	<p><i>Ruby</i> formatting as used in Japanese is described in JIS X-4051 [[JIS4051]] (in Japanese)
	and in Requirements for Japanese Text Layout [[JLREQ]] (in English and Japanese)].
	In HTML, ruby structure and markup to represent it is described
	in the Ruby Markup Extension specification.
	This module describes the CSS rendering model
	and formatting controls relevant to ruby layout of such markup.

<h2 id="ruby-model">
Ruby Formatting Model</h2>

	<p>The CSS ruby model is based on
	the <a href="http://darobin.github.io/html-ruby/">HTML Ruby Markup Extension</a>
	and <a href="http://www.w3.org/TR/ruby/">XHTML Ruby Annotation Recommendation</a> [[RUBY]].
	In this model, a ruby structure consists of
	one or more <dfn>ruby base</dfn> elements representing the base (annotated) text,
	associated with one or more levels of <dfn>ruby annotation</dfn> elements representing the annotations.
	The structure of ruby is similar to that of a table:
	there are “rows” (the base text level, each annotation level)
	and “columns” (each <i>ruby base</i> and its corresponding <i>ruby annotations</i>).

	<p>Consecutive bases and annotations are grouped together into <dfn>ruby segments</dfn>.
	Within a <i>ruby segment</i>, a <i>ruby annotation</i> may span multiple <i>ruby bases<i>.

	<p class="note">In HTML, a single <code>&lt;ruby&gt;</code> element may contain multiple <i>ruby segments</i>.
	(In the XHTML Ruby model, a single <code>&lt;ruby&gt;</code> element can only contain one <i>ruby segment</i>.)

<h3 id="ruby-display">
Ruby-specific 'display' property values</h3>

	<p>For document languages (such as XML applications) that do not have pre-defined ruby elements,
	authors must map document language elements to ruby elements;
	this is done with the 'display' property.

	<table class="propdef">
		<tr>
			<th>Name:
			<td>display
		<tr>
			<th><a href="#values">New Values</a>:
			<td>ruby | ruby-base | ruby-text | ruby-base-container | ruby-text-container
	</table>

	<p>The following new 'display' values assign ruby layout roles to an arbitrary element:

	<dl>
		<dt>''ruby''
			<dd>Specifies that an element generates a <dfn title="ruby container | ruby container box">ruby container box</dfn>.
			(Corresponds to HTML/XHTML <code>&lt;ruby&gt;</code> elements.)
		<dt>''ruby-base''
			<dd>Specifies that an element generates a <dfn title="ruby base box | ruby base">ruby base box</dfn>.
			(Corresponds to HTML/XHTML <code>&lt;rb&gt;</code> elements.)
		<dt>''ruby-text''
			<dd>Specifies that an element generates a <dfn title="ruby annotation box | ruby annotation">ruby annotation box</dfn>.
			(Corresponds to HTML/XHTML <code>&lt;rt&gt;</code> elements.)
		<dt>''ruby-base-container''
			<dd>Specifies that an element generates a <dfn title="ruby base container box | ruby base container">ruby base container box</dfn>.
			(Corresponds to XHTML <code>&lt;rbc&gt;</code> elements; always implied in HTML.)
		<dt>''ruby-text-container''
			<dd>Specifies that an element generates a <dfn title="ruby annotation container box | ruby annotation container">ruby annotation container box</dfn>.
			(Corresponds to HTML/XHTML <code>&lt;ruby&gt;</code> elements.)
	</dl>

<h3 id="box-fixup">
Anonymous Ruby Box Generation</h3>

	<p>The CSS model does not require that the document language
	include elements that correspond to each of these components.
	Missing parts of the structure are implied through the anonymous box generation rules
	<a href="http://www.w3.org/TR/CSS21/tables.html#anonymous-boxes">similar to those used to normalize tables</a>. [[!CSS21]]

	<ol>
		<li>Any in-flow block-level boxes directly contained by a
		<i>ruby container</i>,
		<i>ruby base container</i>,
		<i>ruby annotation container</i>,
		<i>ruby base box</i>,
		or <i>ruby annotation box</i>
		are forced to be inline-level boxes,
		and their 'display' value computed accordingly.
		For example,
		the 'display' property of an in-flow element with ''display: block''
		parented by an element with ''display: ruby-text''
		computes to ''inline-block''.
		This computation occurs after any intermediary anonymous-box fixup
		(such as that required by internal table elements).

		<li>Any consecutive sequence of <i>ruby bases</i> not parented by a <i>ruby base container</i>
		is wrapped in an anonymous <i>ruby base container</i>.
		Similarly, any consecutive sequence of <i>ruby annotations</i> not parented by a <i>ruby annotation container</i>
		is wrapped in an anonymous <i>ruby annotation container</i>.

		<li>Within each <i>ruby base container</i>,
		each sequence of inline-level boxes is wrapped in an anonymous <i>ruby base box</i>.
		Similarly, within each <i>ruby annotation container</i>,
		each sequence of inline-level boxes is wrapped in an anonymous <i>ruby annotation box</i>.

		<li>A sequence of <i>ruby base containers</i> and/or <i>ruby annotation containers</i>
		not parented by a <i>ruby container</i>
		is wrapped in an anonymous <i>ruby container</i>.
	</ol>

	<p>At this point, all ruby layout structures are properly parented,
	and the UA can start to associate bases with their annotations.

	<p class="note">
	Note that the UA is not required to create any of these anonymous boxes in its internal structures,
	as long as pairing and layout behaves as if they existed.

<h3 id="pairing">
Ruby Pairing and Annotation Levels</h3>

	<p>Within a ruby structure,
	each <i>ruby bases</i> are associated with <i>ruby annotations</i>
	and vice versa.
	A <i>ruby base</i> can be associated with at most one <i>ruby annotation</i> per annotation level.
	If there are multiple annotation levels, it can therefore be associated with multiple <i>ruby annotations</i>.
	A <i>ruby annotation</i> is associated with one or more <i>ruby bases</i>;
	annotations can span multiple bases.

	<p><dfn>Annotation pairing</dfn> is the process of associating
	<i>ruby annotations</i> with <i>ruby bases</i>.

	<ol>
		<li>
		<p>First, the ruby structure is divided into <i>ruby segments</i>,
		each consisting of a single <i>ruby base container</i>
		followed by one or more <i>ruby annotation containers</i>.
		If the first child of a <i>ruby container</i> is a <i>ruby annotation container</i>,
		an anonymous, empty <i>ruby base container</i> is assumed to exist before it.
		Similarly, if the <i>ruby container</i> contains consecutive <i>ruby base containers</i>,
		anonymous, empty <i>ruby annotation containers</i> are assumed to exist between them.
		The <i>ruby base container</i> in each segment is thus associated
		with each of the <i>ruby annotation containers</i> in that segment.

		<p>Each <i>ruby annotation containers</i> in a <i>ruby segment</i>
		represents one <dfn title="annotation level | level">level</dfn> of annotation:
		the first one represents the first level of annotation,
		the second one represents the second level of annotation,
		and so on.

		<li>Within each <i>ruby segment</i>,
		each <i>ruby base box</i> in the <i>ruby base container</i>
		is paired with one <i>ruby annotation box</i>
		from each <i>ruby annotation container</i> in its <i>ruby segment</i>.
		If there are not enough <i>ruby annotations</i> in a <i>ruby annotation container</i>,
		the last one is associated with any excess <i>ruby bases</i>.
		(If there are not any in the <i>ruby annotation container</i>, an anonymous empty one is assumed to exist.)
		If there are not enough <i>ruby bases</i>,
		any remaining <i>ruby annotations</i> are assumed to be associated
		with empty, anonymous bases inserted at the end of the <i>ruby base container</i>.

		<p>If an implementation supports ruby markup with explicit spanning
		(e.g. XHTML Complex Ruby Annotations),
		it must adjust the pairing rules to pair spanning annotations to multiple bases
		appropriately.
	</ol>

	<p>A this point, ruby “columns” are defined,
	each represented by a single <i>ruby base</i>
	and associated with one <i>ruby annotation</i> (possibly an empty, anonymous one)
	from each <i>annotation level</i>.

<h4 id="nested-pairing">
Nested Ruby</h4>

	<p>When <i>ruby containers</i> are nested,
	pairing begins with the deepest <i>ruby container</i>,
	then expands out,
	treating each <i>ruby container</i> nested within another <i>ruby container</i>
	as a <i>ruby base</i>,
	and associating each <i>ruby annotation</i>
	associated with the nested <i>ruby container</i>
	as being associated with (spanning) all of its <i>ruby bases</i>.

	<p>Using nested <i>ruby containers</i> thus allows the representation
	of complex spanning relationships.

	<p class="issue">This shouldn't belong in Level 1. But HTML5 allows it, so we have to handle it. Yay HTML5.

<h3 id="autohide">
Autohiding Annotations</h3>

	<p>If a <i>ruby annotation</i> has the exact same content as its base,
	it is <dfn title="hidden ruby annotation | hidden annotation">hidden</dfn>.
	Hiding a <i>ruby annotation</i> does not affect annotation pairing
	or the block-axis positioning of boxes in other <i>levels</i>.
	However the <i>hidden annotation</i> is not visible,
	and it has no impact on layout
	other than to separate adjacent sequences of <i>ruby annotation boxes</i> within its level,
	as if they belonged to separate segments
	and the <i>hidden annotation</i>’s base were not a <i>ruby base</i> but an intervening inline.

	<div class="example">
		<p>This is to allow correct inlined display of annotations
		for Japanese words that are a mix of kanji and hirangana.
		For example, the word <i>振り仮名</i> should be inlined as
		<p class="figure">振り仮名(ふりがな)
		<p>and therefore marked up as
		<pre>
<!--		-->&lt;ruby>
<!--		-->  &lt;rb>振&lt;/rb>&lt;rb>り&lt;/rb>&lt;rb>仮&lt;/rb>&lt;rb>名&lt;/rb>
<!--		-->  &lt;rp>(&lt;/rp>&lt;rt>ふ&lt;/rt>&lt;rt>り&lt;/rt>&lt;rt>が&lt;/rt>&lt;rt>な&lt;/rt>&lt;rp>)&lt;/rp>
<!--		-->&lt;ruby></pre>
		<p>However, when displayed as ruby, the “り” should be hidden
		<div class="figure">
			<p><img src="images/furigana-separate.png"
			        alt="Hiragana annotations for 振り仮名 appear, each above its base character.">
			<p class="caption">Hiragana ruby for 振り仮名
		</div>
	</div>

	<p class="note">
		Future levels of CSS Ruby may add controls for this,
		however in this level it is always forced.

	<p>The content comparison for this auto-hiding behavior
	takes place prior to white space collapsing.
	<span class="issue">Is this easier? Or after collapsing is easier? We should do whatever is easier, as it really doesn't matter much which way to go.

<h3 id="white-space">
White Space</h3>

	<p class="issue">I'm unsure exactly where space should be trimmed. :/
	But pretty sure we need to keep spaces between things,
	otherwise ruby only works for CJK.

	<p><i>Collapsible</i> white space within a ruby structure is discarded
	at the beginning and end of a <i>ruby container</i>,
	and at the beginning/end of a <i>ruby annotation box</i> or <i>ruby base box</i> if white space is not its only contents.
	Between <i>ruby segments</i>, between <i>ruby bases</i>, and between <i>ruby annotations</i>, however,
	white space is not discarded.
	If such white space is <i>collapsible</i>, it will collapse
	following the standard <a href="http://www.w3.org/TR/css3-text/#white-space-rules">white space processing rules</a>. [[!CSS3-TEXT]]
	Between <i>ruby segments</i>, however,
	the contextual text for determining collapsing behavior is given by the <i>ruby bases</i> on either side,
	not the text on either side of the white space in the source document.

	<div class="note">
		<p>Note that the white space processing rules
		cause a white space sequence containing a <i>segment break</i> (such as a line feed)
		to <a href="http://www.w3.org/TR/css3-text/#line-break-transform">collapse to nothing</a> between CJK characters.
		This means that CJK ruby can safely use white space for indentation of the ruby markup.
		For example, the following markup will display without any spaces:
		<pre>
<!--		-->&lt;ruby>
<!--		-->  &lt;rb>東&lt;/rb>&lt;rb>京&lt;/rb>
<!--		-->  &lt;rt>とう&lt;/rt>&lt;rt>きょう&lt;/rt>
<!--		-->&lt;/ruby></pre>
		<p>However, this markup will:
		<pre>
<!--		-->&lt;ruby>
<!--		-->  &lt;rb>東&lt;/rb>	&lt;rb>京&lt;/rb>
<!--		-->  &lt;rt>とう&lt;/rt>	&lt;rt>きょう&lt;/rt>
<!--		-->&lt;/ruby></pre>
	</div>

	<p>Any preserved white space is then wrapped in an anonymous box belonging to
	the <i>ruby base container</i> (if between <i>ruby bases</i>),
	<i>ruby annotation container</i> (if between <i>ruby annotations</i>),
	or <i>ruby container</i> (if between <i>ruby segments</i>).
	In the latter case, the text is considered part of the <i>base level</i>.
	This box does not take part in pairing.
	It merely ensures separation between adjacent bases/annotations.

	<div class="example">
		<p>These rules allow ruby to be used with space-separated scripts such as Latin.
		For example,
		<pre>
<!--		-->&lt;ruby>
<!--		-->  &lt;rb>W&lt;/rb>&lt;rb>W&lt;/rb>&lt;rb>W&lt;/rb>
<!--		-->  &lt;rt>World&lt;/rt> &lt;rt>Wide&lt;/rt> &lt;rt>Web&lt;/rt>
<!--		-->&lt;/ruby></pre>
		<p>They also ensure that annotated white space is preserved. For example,
		<pre>
<!--		-->&lt;ruby>
<!--		-->  &lt;rb>Aerith&lt;/rb>&lt;rb> &lt;/rb>&lt;rb>Gainsboro&lt;/rb>
<!--		-->  &lt;rt>エアリス&lt;/rt>&lt;rt>・&lt;/rt>&lt;rt>ゲインズブール&lt;/rt>
<!--		-->&lt;/ruby></pre>
	</div>

	<p class="issue">Specify how this impacts layout, or not.

<h3 id="line-breaking">
Ruby box and line breaking</h3>

	<p>When there is not enough space for an entire <i>ruby container</i> to fit on the line,
	the ruby may be broken wherever all levels allow a break.
	In typical cases, line breaks are forbidden within each <i>ruby base</i> and <i>ruby annotation</i>,
	so the <i>ruby container</i> can only break between adjacent <i>ruby bases</i>,
	and only if no <i>ruby annotations</i> span those <i>ruby bases</i>.
	Whenever ruby breaks across lines, <i>ruby annotations</i>
	<em>must</i> stay with their respective bases.

	<div class="figure">
		<p><img src="images/r-break-a.gif"
		     alt="Diagram showing the line breaking opportunity in a complex ruby">
		<p class="caption">Ruby line breaking opportunity
	</div>

	<p>Whether ruby can break between two adjacent <i>ruby bases</i>
	is controlled by normal line-breaking rules for the affected text,
	exactly as if the <i>ruby bases</i> were regular <i>inline</i> boxes.

	<div class="example">
		<p>For example, if two adjacent ruby bases are “蝴” and “蝶”,
		the line may break between them,
		because lines are normally allowed to break between two Han characters.
		However, if 'word-break' is ''keep-all'', that line break is forbidden.
	</div>

	<p>Inter-base white space is significant for evaluating line break opportunities between <i>ruby bases</i>.
	As with white space between inlines, it collapses when the line breaks there.

	<div class="example">
		<p>For example, given the following markup:
		<pre>&lt;ruby>&lt;rb>one&lt;/rb> &lt;rb>two&lt;/rb> &lt;rt>1&lt;/rt> &lt;rt>2&lt;/rt>&lt;/ruby></pre>
		<p>Due to the space, the line may break between “one” and “two“.
		If the line breaks there, that space disappears,
		in accordance with standard CSS white space processing rules. [[CSS3-TEXT]]
	</div>

	<p>The line <em>must not</em> break between a <i>ruby base</i> and its annotations.

	<div class="figure">
		<img src="images/r-break-b.gif"
		     alt='Diagram showing the line breaking opportunity in a "Bopomofo" ruby'>
		<p class="caption">''inter-character'' ruby line breaking opportunity
	</div>

<h3 id="line-height">
Ruby box and line stacking</h3>

	<p>The 'line-height' property controls spacing between lines in CSS.
	When inline content on line is shorter than the 'line-height',
	half-leading is added on either side of the content,
	as specificed in <a href="http://www.w3.org/TR/CSS21/visudet.html#line-height">CSS2.1&sect;10.8</a>. [[!CSS21]]

	<p>In order to ensure consistent spacing of lines,
	documents with ruby typically ensure that the 'line-height' is large enough
	to accommodate ruby between lines of text.
	Therefore, ordinarily, <i>ruby annotation containers</i> and <i>ruby annotation boxes</i>
	do not contribute to the measured height of a line's inline contents;
	any alignment (see 'vertical-align') and line-height calculations
	are performed using only the <i>ruby base container</i>,
	exactly as if it were a normal inline.

	<p>However, if the 'line-height' specified on the <i>ruby container</i>
	is less than the distance between
	the top of the top <i>ruby annotation container</i>
	and the bottom of the bottom <i>ruby annotation container</i>,
	then additional leading is added
	on the appropriate side of the <i>ruby base container</i>
	such that if a block consisted of three lines
	each containing ruby identical to this,
	none of the <i>ruby containers</i> would overlap.

	<p class="note">Note that this does not ensure that the <i>ruby annotations</i> remain within the line box.
	It merely ensures that <em>if all lines had equal spacing</em>
	and equivalent amounts and positioning of <i>ruby annotations</i>,
	there would be enough room to avoid overlap.

	<p>Authors should ensure appropriate 'line-height' and 'padding' to accommodate ruby,
	and be particularly careful at the beginning or end of a block
	and when a line contains inline-level content
	(such as images, inline blocks, or elements shifted with 'vertical-align')
	taller than the paragraph's default font size.

	<div class="figure">
		<p><img src="images/rlh-a.gif"
		        alt="The content of each line sits in the middle of its line height;
		             the additional space on each side is called half-leading.
		             Ruby fits between lines if it is smaller than twice the half-leading,
		             but this means that it occupies space belonging to the half-leading of the previous line.">
		<p class="caption">Ruby annotations will often overflow the line;
		authors should ensure content over/under a ruby-annotated line
		is adequately spaced to leave room for the ruby.
	</div>

	<p class="note">More control over how ruby affects alignment and line layout
	will be part of the CSS Line Layout Module Level 3.
	Note, it is currently in the process of being rewritten;
	the current drafts should not be relied upon.

<h2 id="ruby-props">
Ruby Properties</h2>

	<p>The following properties are introduced to control ruby positioning and alignment.

<h3 id="rubypos">
Ruby positioning: the 'ruby-position' property</h3>

	<table class="propdef">
		<tr>
			<th>Name:
			<td><dfn>ruby-position</dfn>
		<tr>
			<th><a href="#values">Value</a>:
			<td>[ over | under | inter-character ] && [ right | left ]
		<tr>
			<th>Initial:
			<td>over right
		<tr>
			<th>Applies to:
			<td>ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value
		<tr>
			<th>Animatable:
			<td>no
		<tr>
			<th>Canonical order:
			<td><abbr title="follows order of property value definition">per grammar</abbr>
	</table>

	<p>This property controls position of the ruby text with respect to its base.
	Values have the following meanings:

	<p class="issue"><span class="issuehead">Issue-107:&nbsp;</span> Roland Steiner has requested the addition of an auto value as default. See <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=ruby-position%3A+undesirable+default+value+%27before%27+for+complex+ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=www-style&amp;resultsperpage=20&amp;sortby=date">this thread</a> and <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=Styling+of+complex+Ruby&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;period_month=&amp;period_year=&amp;index-grp=Public__FULL&amp;index-type=t&amp;type-index=public-i18n-core&amp;resultsperpage=20&amp;sortby=date">this one</a>.</p>
	<dl>
		<dt><dfn title="ruby-position:over">''over''</dfn>
		<dd>The ruby text appears <i>over</i> the base in horizontal text.

			<div class="figure">
				<p><img src="images/shinkansen-top.gif"
				        alt="Diagram of ruby glyph layout in horizontal mode with ruby text appearing above the base">
				<p class="caption">Ruby over Japanese base text in horizontal layout
			</div>
		</dd>

		<dt><dfn title="ruby-position:right">''right''</dfn>
		<dd>The ruby text appears on the right side of the base in vertical text.
			<div class="figure">
				<p><img src="images/shinkansen-right.gif" width="33"
				        alt="Diagram of ruby glyph layout in vertical mode with ruby text apearing vertically on the right of the base">
				<p class="caption">Ruby to the right of Japanese base text in vertical layout
			</div>
		</dd>

		<dt><dfn title="ruby-position:under">''under''</dfn>
		<dd>The ruby text appears under the base in horizontal text.
			This is a relatively rare setting used in ideographic East Asian writing systems,
			most easily found in educational text.

			<div class="figure">
				<p><img src="images/shinkansen-bottom.gif"
				        alt="Diagram of ruby glyph layout in horizontal mode with ruby text appearing below the base">
				<p class="caption">Ruby under Japanese base text in horizontal layout
			</div>
		</dd>

		<dt><dfn title="ruby-position:left">''left''</dfn>
		<dd>The ruby text appears on the left side of the base in vertical text.

			<div class="figure">
				<p><img src="images/shinkansen-left.gif"
				        alt="Diagram of ruby glyph layout in vertical mode with ruby text apearing vertically on the left of the base">
				<p class="caption">Ruby to the left of Japanese base text in vertical layout
			</div>
		</dd>

		<dt><dfn title="ruby-position:inter-character">''inter-character''</dfn></dt>
		<dd>
			<p>The ruby text appears on the right of the base in horizontal text.
			This value forces the 'writing-mode' of the <i>ruby annotation</i> to be vertical.
			
			<p>This value is provided for the special case of traditional Chinese
			as used especially in Taiwan:
			ruby (made of <a href="#g-bopomofo">bopomofo</a> glyphs) in that context
			appears vertically along the right side of the base glyph,
			even when the layout of the base characters is horizontal:

				<div class="figure">
					<p><img src="images/bopomofo.gif"
					        alt="Example of Taiwanese-style ruby">
					<p class="caption">“Bopomofo” ruby in traditional Chinese
					(ruby text shown in blue for clarity) in horizontal layout
				</div>
			<p class="note">
				Note that the user agent is responsible for ensuring the correct relative alignment and positioning of the glyphs,
				including those corresponding to the tone marks, when displaying.
				Tone marks are spacing characters that occur (in memory) at the end of the ruby text for each base character.
				They are usually displayed in a separate column to the right of the bopomofo characters,
				and the height of the tone mark depends on the number of characters in the syllable.
				One tone mark, however, is placed above the bopomofo, not to the right of it.
			<!-- See Taiwanese requirements doc for EPUB at http://epub-revision.googlecode.com/files/EGLS_TW_eng.ppt -->
		</dd>
	</dl>

	<p>If multiple <i>ruby annotation containers</i> have the same 'ruby-position',
	they stack along the block axis,
	with lower levels of annotation closer to the base text.

<h3 id="collapsed-ruby">
Collapsed Ruby Annotations: the 'ruby-merge' property</h3>

	<table class="propdef">
		<tr>
			<th>Name:
			<td><dfn>ruby-merge</dfn>
		<tr>
			<th><a href="#values">Value</a>:
			<td>separate | collapse | auto
		<tr>
			<th>Initial:
			<td>separate
		<tr>
			<th>Applies to:
			<td>ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value
		<tr>
			<th>Animatable:
			<td>no
		<tr>
			<th>Canonical order:
			<td><abbr title="follows order of property value definition">per grammar</abbr>
	</table>

	<p>
		This property controls how ruby annotation boxes should be rendered
		when there are more than one in a ruby container box.

	<p>Possible values:</p>
	<dl>
		<dt><dfn title="ruby-merge:separate">''separate''</dfn>
		<dd>
			<p>
				Each ruby annotation box is rendered in the same column(s) as its corresponding base box(es).
				This style is called “mono ruby” in [[JLREQ]].

			<div class="example">
				<p>For example, the following two markups render the same:
				<pre>&lt;ruby&gt;無&lt;rt&gt;む&lt;/ruby&gt;&lt;ruby&gt;常&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
				<p>and:
				<pre>&lt;ruby style="ruby-merge:separate"&gt;&lt;rb&gt;無&lt;rb&gt;常&lt;rt&gt;む&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
			</div>
		</dd>

		<dt><dfn title="ruby-merge:collapse">''collapse''</dfn>
		<dd>
			<p>
				All <i>ruby annotation boxes</i> within the same <i>ruby segment</i> on the same line are concatenated,
				and laid out as if their contents belonged to a single <i>ruby annotation box</i>
				spanning all their associated <i>ruby base boxes.
				This style renders similar to “group ruby” in [[JLREQ]],
				except that <i>ruby annotations</i> are kept together with their respective <i>ruby bases</i> when breaking lines.
			</p>

			<div class="example">
				<p>The following two markups render the same both characters fit on one line:
				<pre>&lt;ruby&gt;無常&lt;rt&gt;むじょう&lt;/ruby&gt;</pre>
				<p>and:
				<pre>&lt;ruby style="ruby-merge:collapse"&gt;&lt;rb&gt;無&lt;rb&gt;常&lt;rt&gt;む&lt;rt&gt;じょう&lt;/ruby&gt;</pre>
				<p>However, the second one renders the same as ''ruby-position: separate''
				when the two bases are split across lines.
			</div>
		</dd>

		<dt><dfn title="ruby-merge:auto">''auto''</dfn></dt>
		<dd>
			<p>
				The user agent may use any algorithm to determine how each ruby annotation box
				is rendered to its corresponding base box.
			<div class="example">
			<p>
				One possible algorithm is described as Jukugo-ruby in [[JLREQ]].
			<p>
				Another, more simplified algorithm of Jukugo-ruby is
				to render as Mono-ruby if all ruby annotation boxes fit within
				advances of their corresponding base boxes,
				and render as Group-ruby otherwise.
			</p>
			</div>
		</dd>
	</dl>

<h3 id="rubyalign">
Ruby Text Distribution: the 'ruby-align' property</h3>

	<table class="propdef">
		<tr>
			<th>Name:
			<td><dfn>ruby-align</dfn>
		<tr>
			<th><a href="#values">Value</a>:
			<td>auto | start | center |
				distribute-letter | distribute-space
		<tr>
			<th>Initial:
			<td>auto
		<tr>
			<th>Applies to:
			<td>ruby bases, ruby annotations, ruby base containers, ruby annotation containers
		<tr>
			<th>Inherited:
			<td>yes
		<tr>
			<th>Percentages:
			<td>N/A
		<tr>
			<th>Media:
			<td>visual
		<tr>
			<th>Computed value:
			<td>specified value (except for initial and inherit)
	</table>

	<p>This property specifies how text is distributed within the various ruby boxes
		when their text contents exactly fill their respective boxes.

	<p>Values have the following meanings:
	<p class="issue"><span class="issuehead">Issue:&nbsp;</span> Tony Graham has <a href="http://www.w3.org/Style/XSL/Group/FO/wiki/Ruby#Treat_CSS3_.22ruby-align.22_As_Shorthand.3F">suggested </a>that distribute-letter and distribute-space be values of a ruby-group-distribution property, and line-edge be moved to a ruby-alignment-edge property, and that the rest be gathered under a ruby-alignment property. And that ruby-align become a shorthand.</p>
	<dl>
		<dt><dfn title="ruby-align:auto">''auto''</dfn></dt>
		<dd>
			<p>The user agent determines how the ruby contents are aligned.
				This is the initial value.
				The behavior recommended by [[JLREQ]] is for  wide-cell ruby  to be aligned in the 'distribute-space' mode:
				<div class="figure">
					<p><img width="145" height="91"
					alt="Diagram of glyph layout in auto aligned ruby when ruby text is shorter than base"
					src="images/ra-ds.gif" /><img width="145" height="91"
					alt="Diagram of glyph layout in auto aligned ruby when ruby text is longer than base"
					src="images/ra-ds-rb.gif" /></p>
					<p><b>Figure 4.2.1</b>: Wide-cell text in 'auto' ruby alignment is
					'distribute-space' justified</p>
				</div>

			<p>The recommended behavior for  narrow-cell glyph ruby is to be
				aligned in the 'center' mode.</p>
				<div class="figure">
					<p><img
					alt="Diagram of glyph layout in auto aligned ruby when halfwidth ruby text is shorter than base"
					width="145" height="91"
					src="images/ra-c-h.gif" /><img
					alt="Diagram of character layout in auto aligned ruby when ruby text is longer than narrow-width base"
					width="145" height="91"
					src="images/ra-c-rb-h.gif" /></p>
					<p><b>Figure 4.2.2</b>: Narrow-width ruby text in 'auto' ruby alignment
					is centered</p>
				</div>
		</dd>

		<dt><dfn title="ruby-align:start">''start''</dfn></dt>
		<dd>The ruby annotation content is aligned with the start edge of the base.
			<div class="figure">
				<p><img
					alt="Diagram of glyph layout in left aligned ruby when ruby text is shorter than base"
					width="145" height="91" src="images/ra-l.gif" /><img
					width="145" height="91"
					alt="Diagram of glyph layout in left aligned ruby when ruby text is longer than base"
					src="images/ra-l-rb.gif" /></p>
				<p><b>Figure 4.2.3</b>: Start ruby alignment</p>
			</div>
		</dd>

		<dt><dfn title="ruby-align:center">''center''</dfn></dt>
		<dd>The ruby text content is centered within the width of the base. If the
			length of the base is smaller than the length of the ruby text, then the
			base is centered within the width of the ruby text.

			<div class="figure">
				<p><img width="145" height="91"
					alt="Diagram of glyph layout in center aligned ruby when ruby text is shorter than base"
					src="images/ra-c.gif" /><img width="145" height="91"
					alt="Diagram of glyph layout in center aligned ruby when ruby text is longer than base"
					src="images/ra-c-rb.gif" /></p>
				<p><b>Figure 4.2.4</b>: Center ruby alignment</p>
			</div>
		</dd>

		<!--
  <dt><strong>right</strong></dt>
    <dd>The ruby text content is aligned with the end edge of the base.
    	<p class="issue"><span class="issuehead">Issue:&nbsp;</span> The i18n WG feels that end and right should not be synonymous, and proposed to drop right (there is no left/right in overhang)? See <a href="http://www.w3.org/Search/Mail/Public/advanced_search?keywords=&amp;hdr-1-name=subject&amp;hdr-1-query=[CSS3+Ruby]%20left/start+and+right/end&amp;hdr-2-name=from&amp;hdr-2-query=&amp;hdr-3-name=message-id&amp;hdr-3-query=&amp;index-grp=Member__FULL+Public__FULL&amp;index-type=t&amp;type-index=public-i18n-core%40w3.org&amp;resultsperpage=20&amp;sortby=date">this thread</a>.</p>
<div class="figure">
	<p><img class="example" width="145" height="91"
      alt="Diagram of glyph layout in right aligned ruby when ruby text is shorter than base"
      src="images/ra-r.gif" /><img class="example" width="145" height="91"
      alt="Diagram of glyph layout in right aligned ruby when ruby text is longer than base"
      src="images/ra-r-rb.gif" /></p>
	<p><b>Figure 4.2.5</b>: End ruby alignment</p>
</div>
    </dd>
		-->

		<dt><dfn title="ruby-align:distribute-letter">''distribute-letter''</dfn></dt>
		<dd>If the width of the ruby text is smaller than that of the base, then
			the ruby text contents are evenly distributed across the width of the
			base, with the first and last ruby text glyphs lining up with the
			corresponding first and last base glyphs. If the width of the ruby text
			is at least the width of the base, then the letters of the base are
			evenly distributed across the width of the ruby text.

			<div class="figure">
				<p><img width="145" height="91"
				alt="Diagram of glyph layout in distribute-letter aligned ruby when ruby text is shorter than base"
				src="images/ra-dl.gif" /><img width="145" height="91"
				alt="Diagram of glyph layout in distribute-letter aligned ruby when ruby text is longer than base"
				src="images/ra-dl-rb.gif" /></p>
				<p><b>Figure 4.2.6</b>: Distribute-letter ruby alignment</p>
			</div>
		</dd>

		<dt><dfn title="ruby-align:distribute-space">''distribute-space''</dfn></dt>
		<dd>If the width of the ruby text is smaller than that of the base, then
			the ruby text contents are evenly distributed across the width of the
			base, with a certain amount of white space preceding the first and
			following the last character in the ruby text. That amount of white
			space is normally equal to half the amount of inter-character space of
			the ruby text. If the width of the ruby text is at least the width of
			the base, then the same type of space distribution applies to the base.
			In other words, if the base is shorter than the ruby text, the base is
			distribute-space aligned. This type of alignment
			is described by [[JLREQ]].

			<div class="figure">
				<p><img width="145" height="91"
					alt="Diagram of glyph layout in distribute-space aligned ruby when ruby text is shorter than base"
					src="images/ra-ds.gif" /><img width="145" height="91"
					alt="Diagram of glyph layout in distribute-space aligned ruby when ruby text is longer than base"
					src="images/ra-ds-rb.gif" /></p>
				<p><b>Figure 4.2.7</b>: Distribute-space ruby alignment</p>
			</div>
		</dd>

		<!--
  <dt><strong>line-edge</strong></dt>
    <dd>If the ruby text is not adjacent to a line edge, it is aligned as in
      'auto'. If it is adjacent to a line edge, then it is still aligned as in
      auto, but the side of the ruby text that touches the end of the line is
      lined up with the corresponding edge of the base. This type of alignment
      is described by [[JLREQ]]. This type of alignment is
      relevant only to the scenario where the ruby text is longer than the
      ruby base. In the other scenarios, this is just 'auto'.
		<div class="figure">
      <p><img class="example" width="146" height="109"
      alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is shorter than base"
      src="images/ra-le-l.gif" /><img class="example" width="146"
      height="110"
      alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is longer than base"
      src="images/ra-le-r.gif" /></p>
      <p><b>Figure 4.2.8</b>: Line edge ruby alignment</p>
      </div>
    </dd>
		-->
	</dl>

	<p>For a complex ruby with spanning elements, one additional consideration is
		required. If the spanning element spans multiple 'rows' (other rbc or rtc
		elements), and the ruby alignment requires space distribution among the
		'spanned' elements, a ratio must be determined among the 'columns' of spanned
		elements. This ratio is computed by taking into consideration the widest
		element within each column.</p>

<h2 id="edge-effects">
Edge Effects</h2>

<h3 id="ruby-overhang">
Overhanging Ruby</h3>

	<p>
		When <i>ruby annotation box</i> is longer than its corresponding <i>ruby base box</i>,
		the <i>ruby annotation box</i> may partially overhang adjacent boxes.
	</p>
	<p>
		This level of the specification does not define
		how much the overhang may be allowed, and under what conditions.
	</p>

	<p>If the ruby text is not allowed to overhang,
	then the ruby behaves like a traditional inline box,
	i.e. only its own contents are rendered within its boundaries
	and adjacent elements do not cross the box boundary:

	<div class="figure">
		<p><img src="images/ro-n.gif"
		        alt="Diagram showing the ruby boxes interacting with adjacent text">
		<p class="caption">Simple ruby whose text is not allowed to overhang adjacent text
	</div>

	<p>However, if <i>ruby annotation</i> content is allowed to overhang adjacent elements
	and it happens to be wider than its base,
	then the adjacent content is partially rendered within the area of the <i>ruby container box</i>,
	while the <i>ruby annotation</i> may partially overlap the upper blank parts of the adjacent content:

	<div class="figure">
	<p><img src="images/ro-a.gif"
		      alt="Diagram showing the ruby boxes interacting with adjacent text">
	<p class="caption">Simple ruby whose text is allowed to overhang adjacent text
	</div>

	<p>The <i>ruby annotations</i> related to a <i>ruby base</i>
	must never overhang another <i>ruby base</i>.

	<p>The alignment of the contents of the base or the ruby text
	is not affected by overhanging behavior.
	The alignment is achieved the same way regardless of the overhang behavior setting
	and it is computed before the space available for overlap is determined.
	It is controlled by the 'ruby-align' property.

	<p>This entire logic applies the same way in vertical ideographic layout,
	only the dimension in which it works in such a layout is vertical,
	instead of horizontal.

	<div class="example">
	<p>
		The user agent may use [[JIS4051]] recommendation of
		using one ruby text character length as the maximum overhang length.
		Detailed rules for how ruby text can overhang adjacent characters for Japanese are described by [[JLREQ]].
	</p>
	</div>

<h3 id="line-edge">
Line-edge Alignment</h3>

	<p>
		When a <i>ruby annotation box</i> that is longer than its <i>ruby base</i>
		is at the start or end edge of a line,
		the user agent <em>may</em> force the side of the <i>ruby annotation</i> that touches the edge of the line
		to align to the corresponding edge of the base.
		This type of alignment is described by [[JLREQ]].
	</p>
	<p>
		This level of the specification does not provide a mechanism to control this behavior.
	</p>
	<div class="figure">
		<p><img src="images/ra-le-l.gif"
			alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is shorter than base">
			<img src="images/ra-le-r.gif"
			alt="Diagram of glyph layout in line-edge aligned ruby when ruby text is longer than base">
		<p class="caption">Line-edge alignment
	</div>

	<!--
<h3 id="rubyover">
Ruby overhanging: the 'ruby-overhang' property</h3>

  <table class="propdef">
    <tr>
      <th>Name:
      <td><dfn>ruby-overhang</dfn>
    <tr>
      <th>Value:
      <td>auto | start | end | none
    <tr>
      <th>Initial:
      <td>none
    <tr>
      <th>Applies to:
      <td>the parent of elements with display: ruby-text
    <tr>
      <th>Inherited:
      <td>yes
    <tr>
      <th>Percentages:
      <td>N/A
    <tr>
      <th>Media:
      <td>visual
    <tr>
      <th>Computed value:
      <td>specified value (except for initial and inherit)
  </table>

<p>This property determines whether, and on which side, ruby text is allowed
to partially overhang any adjacent text in addition to its own base, when the
ruby text is wider than the ruby base. Note that ruby text is never allowed to
overhang glyphs belonging to another ruby base. <span class="issue"><span class="issuehead">Issue:&nbsp;</span> This rule must be broken if we are to allow support for jukugo ruby.</span> Also the user agent is free to assume
a maximum amount by which ruby text may overhang adjacent text. The user agent may use
the [[JIS4051]] recommendation of using one ruby text character
length as the maximum overhang length. Detailed rules for how ruby text can overhang adjacent characters for Japanese are described by [[JLREQ]].</p>

<p>Possible values:</p>
<dl>
  <dt><strong>auto</strong></dt>
    <dd>The ruby text can overhang text adjacent to the base on either side.   	  [[JLREQ]] and [[JIS4051]] specify the categories of characters that
      ruby text can overhang. The user agent is free to follow those recommendations or specify its own classes of
      characters to overhang. This is the initial value.
		<div class="figure">
      <p><img class="example" width="177" height="91"
      alt="Diagram of glyph layout in overhanging ruby" src="images/ro-a.gif" /></p>
      <p><b>Figure 4.3.1</b>: Ruby overhanging adjacent text</p>
      </div>
    </dd>
  <dt><strong>start</strong></dt>
    <dd>The ruby text can only overhang the text that precedes it. That means, for
      example, that ruby cannot overhang text that is to the right of it in
      horizontal LTR layout, and it cannot overhang text that is below it in
      vertical-ideographic layout.
		<div class="figure">
      <p><img class="example" width="199" height="91"
      alt="Diagram of glyph layout when ruby overhangs the preceding glyphs only"
      src="images/ro-s.gif" /></p>
      <p><b>Figure 4.3.2</b>: Ruby overhanging preceding text only</p>
      </div>
    </dd>
  <dt><strong>end</strong></dt>
    <dd>The ruby text can only overhang the text that follows it. That means, for
      example, that ruby cannot overhang text that is to the left of it in
      horizontal LTR layout, and it cannot overhang text that is above it in
      vertical-ideographic layout.
		<div class="figure">
      <p><img class="example" width="198" height="91"
      alt="Diagram of glyph layout when ruby overhangs the following characters only"
      src="images/ro-e.gif" /></p>
      <p><b>Figure 4.3.3</b>: Ruby overhanging following text only</p>
      </div>
    </dd>
  <dt><strong>none</strong></dt>
    <dd>The ruby text cannot overhang any text adjacent to its base, only its
      own base.

      <div class="figure">
      <p><img class="example" width="220" height="91"
      alt="Diagram of glyph layout in non-overhanging ruby"
      src="images/ro-n.gif" /></p>
      <p><b>Figure 4.3.4</b>: Ruby not allowed to overhang adjacent text</p>
      </div>
    </dd>
</dl>

<h3 id="rubyspan">
Ruby annotation spanning: the 'ruby-span' property</h3>

  <table class="propdef">
    <tr>
      <th>Name:
      <td><dfn>ruby-span</dfn>
    <tr>
      <th>Value:
      <td>attr(x) |  none
    <tr>
      <th>Initial:
      <td>none
    <tr>
      <th>Applies to:
      <td>elements with display: ruby-text
    <tr>
      <th>Inherited:
      <td>no
    <tr>
      <th>Percentages:
      <td>N/A
    <tr>
      <th>Media:
      <td>visual
    <tr>
      <th>Computed value:
      <td>&lt;number&gt;
  </table>

<p>This property controls the spanning behavior of annotation elements. </p>

<p class="note"><span class="note-label">Note:</span> A XHTML user agent may also use the <samp>rbspan</samp> 
attribute to get the same effect.</p>

<p>Possible values:</p>

<dl>
  <dt><strong>attr(x)</strong></dt>
    <dd>The value of attribute 'x' as a string value. The string value is 
    evaluated as a &lt;number&gt; to determine the number of ruby base elements to be 
    spanned by the annotation element. If the &lt;number&gt; is &#39;0&#39;, it is replaced by 
    &#39;1&#39;.The &lt;number&gt; is the computed value. </dd>
  <dt>none</dt>
  <dd>No spanning. The computed value is &#39;1&#39;.</dd>
</dl>

<p>The following example shows an XML example using the 'display' property 
values associated with the 'ruby structure and the 'ruby-span' property</p>
<pre class="xml">myruby       { display: ruby; }
myrbc        { display: ruby-base-container; }
myrb         { display: ruby-base; }
myrtc.before { display: ruby-text-container; ruby-position: before}
myrtc.after  { display: ruby-text-container; ruby-position: after}
myrt         { display: ruby-text; ruby-span: attr(rbspan); }
...
&lt;myruby&gt;
  &lt;myrbc&gt;
    &lt;myrb&gt;10&lt;/myrb&gt;
    &lt;myrb&gt;31&lt;/myrb&gt;
    &lt;myrb&gt;2002&lt;/myrb&gt;
  &lt;/myrbc&gt;
  &lt;myrtc class=&quot;before&quot;&gt;
    &lt;myrt&gt;Month&lt;/myrt&gt;
    &lt;myrt&gt;Day&lt;/myrt&gt;
    &lt;myrt&gt;Year&lt;/myrt&gt;
  &lt;/myrtc&gt;
  &lt;myrtc class=&quot;after&quot;&gt;
    &lt;myrt rbspan=&quot;3&quot;&gt;Expiration Date&lt;/myrt&gt;
  &lt;/myrtc&gt;
&lt;/myruby&gt;</pre>
	-->

<h2 id="default-stylesheet" class="no-num">
Appendix A: Default Style Sheet</h2>

	<p><em>This section is informative.</em>

<h3 id="default-ua-ruby" class="no-num">
<span class="secno">A.1</span> Supporting Ruby Layout</h3>

	<p>The following represents a default UA style sheet
	for rendering HTML and XHTML ruby markup as ruby layout:

	<pre>
<!--	-->ruby { display: ruby; }
<!--	-->rb   { display: ruby-base; white-space: nowrap; }
<!--	-->rt   { display: ruby-text; white-space: nowrap; font-size: 50%; }
<!--	-->rbc  { display: ruby-base-container; }
<!--	-->rtc  { display: ruby-text-container; }</pre>

	<p>Additional rules for UAs supporting the relevant features of [[CSS3-TEXT-DECOR]] and [[CSS3-FONTS]]:
	<pre>rt { font-variant-east-asian: ruby; text-emphasis: none; }</pre>

	<p class="note">Authors should not use the above rules;
	a UA that supports ruby layout should provide these by default.

<h3 id="default-inline" class="no-num">
<span class="secno">A.2</span> Inlining Ruby Annotations</h3>

	<p>The following represents a sample style sheet
	for rendering HTML and XHTML ruby markup as inline annotations:

	<pre>ruby, rb, rt, rbc, rtc, rp {
<!--	-->  display: inline; white-space: inherit;
<!--	-->  font-variant-east-asian: inherit; text-emphasis: inherit; }</pre>

<h3 id="default-parens" class="no-num">
<span class="secno">A.3</span> Generating Parentheses</h3>

	<p>Unfortunately, because Selectors cannot match against text nodes,
	it's not possible with CSS to express rules that will automatically and correctly
	add parentheses to unparenthesized ruby annotations in HTML.
	(This is because HTML ruby allows implying the <i>ruby base</i> from raw text, without a corresponding element.)
	However, these rules will handle cases where either <code>&lt;rb&gt;</code>
	or <code>&lt;rtc&gt;</code> is used rigorously.

	<pre>
<!--	-->/* Parens around &lt;rtc> */
<!--	-->rtc::before { content: "("; }
<!--	-->rtc::after  { content: ")"; }

<!--	-->/* Parens before first &lt;rt> not inside &lt;rtc> */
<!--	-->rb  + rt::before,
<!--	-->rtc + rt::before { content: "("; }

<!--	-->/* Parens after &lt;rt> not inside &lt;rtc> */
<!--	-->rb ~ rt:last-child::after,
<!--	-->rt + rb::before  { content: ")"; }
<!--	-->rt + rtc::before { content: ")("; }</pre>

<h2 id="glossary">
Glossary</h2>
<dl>
  <dt><a id="g-bopomofo"><strong><span
  lang="zh">Bopomofo</span></strong></a></dt>
    <dd>37 characters and 4 tone markings used as phonetics in Chinese,
      especially standard Mandarin.</dd>
  <dt><a id="g-hanja"><strong><span
  lang="ko">Hanja</span></strong></a></dt>
    <dd>Subset of the Korean writing system that utilizes ideographic
      characters borrowed or adapted from the Chinese writing system. Also see
      <a href="#g-kanji"><span lang="ja">Kanji</span></a>.</dd>
  <dt><a id="g-hiragana"><strong><span
  lang="ja">Hiragana</span></strong></a></dt>
    <dd>Japanese syllabic script, or character of that script. Rounded and 
    cursive in appearance. Subset of the Japanese writing system, used together 
    with kanji and katakana. In recent times, mostly used to write Japanese 
    words when kanji are not available or appropriate, and word endings and 
    particles. Also see <a
      href="#g-katakana"><span lang="ja">Katakana</span></a>.</dd>
  <dt><a id="g-ideogram"><strong>Ideograph</strong></a></dt>
    <dd>A character that is used to represent an idea, word, or word component, 
    in contrast to a character from an alphabetic or syllabic script. The most 
    well-known ideographic script is used (with some variation) in East Asia 
    (China, Japan, Korea,...).</dd>
  <dt><a id="g-kana"><strong><span lang="ja">Kana</span></strong></a></dt>
    <dd>Collective term for hiragana and katakana.</dd>
  <dt><a id="g-kanji"><strong>Kanji</strong></a></dt>
    <dd>Japanese term for ideographs; ideographs used in Japanese. Subset of the 
    Japanese writing system, used together with hiragana and katakana. Also see <a
      href="#g-hanja"><span lang="ko">Hanja</span></a>.</dd>
  <dt><a id="g-katakana"><strong><span
  lang="ja">Katakana</span></strong></a></dt>
    <dd>Japanese syllabic script, or character of that script. Angular in 
    appearance. Subset of the Japanese writing system,&nbsp; used together with 
    kanji and hiragana. In recent times, mainly used to write foreign words. Also see <a
      href="#g-hiragana"><span lang="ja">Hiragana</span></a>.</dd>
  <dt><a id="g-monoruby" name="g-monoruby"><strong>Mono-ruby</strong></a></dt>
    <dd>In Japanese typography: Ruby associated with a single character of
      the base text.</dd>
  <dt><a id="g-ruby"><strong>Ruby</strong></a></dt>
    <dd>A run of text that appears in the vicinity of another run of text and
      serves as an annotation or a pronunciation guide for that text.</dd>
</dl>

<h2 id="conformance">
Conformance</h2>

<h3 id="conventions">
Document conventions</h3>

  <p>Conformance requirements are expressed with a combination of
  descriptive assertions and RFC 2119 terminology. The key words “MUST”,
  “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
  “RECOMMENDED”, “MAY”, and “OPTIONAL” in the normative parts of this
  document are to be interpreted as described in RFC 2119.
  However, for readability, these words do not appear in all uppercase
  letters in this specification.
  
  <p>All of the text of this specification is normative except sections
  explicitly marked as non-normative, examples, and notes. [[!RFC2119]]</p>
  
  <p>Examples in this specification are introduced with the words “for example”
  or are set apart from the normative text with <code>class="example"</code>,
  like this:
  
  <div class="example">
    <p>This is an example of an informative example.</p>
  </div>
  
  <p>Informative notes begin with the word “Note” and are set apart from the
  normative text with <code>class="note"</code>, like this:
  
  <p class="note">Note, this is an informative note.</p>

<h3 id="conformance-classes">
Conformance classes</h3>

  <p>Conformance to CSS Ruby Module
  is defined for three conformance classes:
  <dl>
    <dt><dfn title="style sheet!!as conformance class">style sheet</dfn>
      <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#style-sheet">CSS
      style sheet</a>.
    <dt><dfn>renderer</dfn></dt>
      <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#user-agent">UA</a>
      that interprets the semantics of a style sheet and renders
      documents that use them.
    <dt><dfn id="authoring-tool">authoring tool</dfn></dt>
      <dd>A <a href="http://www.w3.org/TR/CSS21/conform.html#user-agent">UA</a>
      that writes a style sheet.
  </dl>
  
  <p>A style sheet is conformant to CSS Ruby Module
  if all of its statements that use syntax defined in this module are valid
  according to the generic CSS grammar and the individual grammars of each
  feature defined in this module.
  
  <p>A renderer is conformant to CSS Ruby Module
  if, in addition to interpreting the style sheet as defined by the
  appropriate specifications, it supports all the features defined
  by CSS Ruby Module by parsing them correctly
  and rendering the document accordingly. However, the inability of a
  UA to correctly render a document due to limitations of the device
  does not make the UA non-conformant. (For example, a UA is not
  required to render color on a monochrome monitor.)
  
  <p>An authoring tool is conformant to CSS Ruby Module
  if it writes style sheets that are syntactically correct according to the
  generic CSS grammar and the individual grammars of each feature in
  this module, and meet all other conformance requirements of style sheets
  as described in this module.

<h3 id="partial">
Partial implementations</h3>

  <p>So that authors can exploit the forward-compatible parsing rules to
  assign fallback values, CSS renderers <strong>must</strong>
  treat as invalid (and <a href="http://www.w3.org/TR/CSS21/conform.html#ignore">ignore
  as appropriate</a>) any at-rules, properties, property values, keywords,
  and other syntactic constructs for which they have no usable level of
  support. In particular, user agents <strong>must not</strong> selectively
  ignore unsupported component values and honor supported values in a single
  multi-value property declaration: if any value is considered invalid
  (as unsupported values must be), CSS requires that the entire declaration
  be ignored.</p>
  
<h3 id="experimental">
Experimental implementations</h3>

  <p>To avoid clashes with future CSS features, the CSS2.1 specification
  reserves a <a href="http://www.w3.org/TR/CSS21/syndata.html#vendor-keywords">prefixed
  syntax</a> for proprietary and experimental extensions to CSS.
  
  <p>Prior to a specification reaching the Candidate Recommendation stage
  in the W3C process, all implementations of a CSS feature are considered
  experimental. The CSS Working Group recommends that implementations
  use a vendor-prefixed syntax for such features, including those in
  W3C Working Drafts. This avoids incompatibilities with future changes
  in the draft.
  </p>
 
<h3 id="testing">
Non-experimental implementations</h3>

  <p>Once a specification reaches the Candidate Recommendation stage,
  non-experimental implementations are possible, and implementors should
  release an unprefixed implementation of any CR-level feature they
  can demonstrate to be correctly implemented according to spec.
  
  <p>To establish and maintain the interoperability of CSS across
  implementations, the CSS Working Group requests that non-experimental
  CSS renderers submit an implementation report (and, if necessary, the
  testcases used for that implementation report) to the W3C before
  releasing an unprefixed implementation of any CSS features. Testcases
  submitted to W3C are subject to review and correction by the CSS
  Working Group.
  
  <p>Further information on submitting testcases and implementation reports
  can be found from on the CSS Working Group's website at
  <a href="http://www.w3.org/Style/CSS/Test/">http://www.w3.org/Style/CSS/Test/</a>.
  Questions should be directed to the
  <a href="http://lists.w3.org/Archives/Public/public-css-testsuite">public-css-testsuite@w3.org</a>
  mailing list.

<h2 class=no-num id="acknowledgments">
Acknowledgments</h2>

<p>This specification would not have been possible without the help from:</p>

<p>Stephen Deach, Martin Dürst,  Hideki Hiura(<span lang="ja">樋浦 秀樹</span>), Masayasu Ishikawa(<span lang="ja">石川
雅康</span>), Chris
Pratley, Takao Suzuki(<span lang="ja">鈴木 孝雄</span>), Frank Yung-Fong Tang, Chris Thrasher, Masafumi Yabe<span lang="ja">家辺
勝文</span>), Steve Zilles.</p>

<h2 class="no-num" id="changes">
Changes</h2>

	<p>The following major changes have been made since the previous Working Draft:
	<dl>
		<dt>Remove 'ruby-span' and mentions of <code>rbspan</code>.
		<dd>
			Explicit spanning is not used in HTML ruby in favor of implicit spanning.
			This can't handle some pathological double-sided spanning cases,
			but there seems to be no requirement for these at the moment.
			(For implementations that support full complex XHTML Ruby,
			they can imply spanning from the markup the same magic way
			that we handle cell spanning from tables. It doesn't seem
			necessary to include controls this in Level 1.)

		<dt>Defer 'ruby-overhang' and ''ruby-align: line-end'' to Level 2.
		<dd>
			It's somewhat complicated, advanced feature.
			Proposal is to make this behavior UA-defined
			and provide some examples of acceptable options.

		<dt>Close issue requesting 'display: rp': use ''display: none''.
		<dd>
			The i18nwg added an issue requesting a display value for &lt;rp> elements.
			They're supposed to be hidden when &tl;ruby> is displayed as ruby.
			But this is easily accomplished already with ''display: none''.

		<dt>Change 'ruby-position' values to match 'text-emphasis-position'.
		<dd>
			Other than ''inter-character'', which we need to keep,
			it makes more sense to align ruby positions with 'text-emphasis-position',
			which can correctly handle various combinations of horizontal/vertical preferences.

		<dt>Remove unused values of 'ruby-align'.
		<dd>
			'left', 'right', and 'end' are not needed.

		<dt>Added 'ruby-merge' property to control jukugo rendering.
		<dd>
			This is a stylistic effect, not a structural one;
			the previous model assumed that it was structural and suggested handling it by changing markup. :(

		<dt>Remove ''inline'' from 'ruby-position'.
		<dd>
			This is do-able via ''display: inline'' on all the ruby-related elements,
			see <a href="#default-inline">Appendix A</a>

		<dt>Added <a href="#default-style">Default Style</a> rules
		<dd>
			As requested by i18nwg.

		<dt>Wrote anonymous box generation rules
		<dd>
			And defined pairing of bases and annotations.
			Should now handle all the crazy proposed permutations of HTML ruby markup.
	</dl>

<h2 class=no-num id="references">
References</h2>

<h3 class="no-num" id="normative-references">
Normative references</h3>
<!--normative-->

<h3 class="no-num" id="other-references">
Other references</h3>
<!--informative-->

<h2 class="no-num" id="index">
Index</h2>
<!--index-->

<h2 class="no-num" id="property-index">
Property index</h2>
<!-- properties -->

</body>
</html>
<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-declaration:"~/SGML/HTML4.decl"
sgml-default-doctype-name:"html"
sgml-minimize-attributes:t
sgml-nofill-elements:("pre" "style" "br")
sgml-live-element-indicator:t
sgml-omittag:nil
sgml-shorttag:nil
sgml-namecase-general:t
sgml-general-insert-case:lower
sgml-always-quote-attributes:t
sgml-indent-step:nil
sgml-indent-data:t
sgml-parent-document:nil
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
-->
 
